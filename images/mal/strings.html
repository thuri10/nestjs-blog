<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"thuri10.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?">
<meta property="og:type" content="blog">
<meta property="og:title" content="Static Analysis of Malware Strings">
<meta property="og:url" content="http://thuri10.github.io/images/mal/strings.html">
<meta property="og:site_name" content="LaByte">
<meta property="og:description" content="Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://thuri10.github.io/post/mal/strings1.png">
<meta property="og:image" content="http://thuri10.github.io/post/mal/strings2.png">
<meta property="og:image" content="http://thuri10.github.io/post/mal/resourcestrings3.png">
<meta property="og:image" content="http://thuri10.github.io/post/mal/strings3.png">
<meta property="og:image" content="http://thuri10.github.io/post/mal/string3rc.png">
<meta property="article:published_time" content="2021-12-07T13:02:13.000Z">
<meta property="article:modified_time" content="2022-09-23T09:58:55.002Z">
<meta property="article:author" content="Thuri">
<meta property="article:tag" content="reverse">
<meta property="article:tag" content="malware">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://thuri10.github.io/post/mal/strings1.png">


<link rel="canonical" href="http://thuri10.github.io/images/mal/strings">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":false,"lang":"en","comments":true,"permalink":"http://thuri10.github.io/images/mal/strings.html","path":"images/mal/strings.html","title":"Static Analysis of Malware Strings"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Static Analysis of Malware Strings | LaByte
</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LaByte</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Messing Bits</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#challenge1-Strings1"><span class="nav-text">challenge1- Strings1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Challenge2-Strings2"><span class="nav-text">Challenge2- Strings2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Challenge3-Strings3"><span class="nav-text">Challenge3 - Strings3</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Thuri</p>
  <div class="site-description" itemprop="description">Messy Bits</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/thuri10" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;thuri10" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:thuri783@gmail.com" title="E-Mail → mailto:thuri783@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/0xhexski" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;0xhexski" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner page posts-expand">


    
    
    
    <div class="post-block" lang="en"><header class="post-header">

<h1 class="post-title" itemprop="name headline">Static Analysis of Malware Strings
</h1>

<div class="post-meta-container">
    <div class="post-description">Strings challenges contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</div>
  <ul class="breadcrumb">
            <li><a href="/images/">IMAGES</a></li>
            <li><a href="/images/mal/">MAL</a></li>
            <li>STRINGS</li>
  </ul>
</div>

</header>

      
      
      <div class="post-body">
          <p>This post is a brief walkthrough of <strong>“strings”</strong> challenges provided by MalwareTech. The challenges can be downloaded from the following website <a target="_blank" rel="noopener" href="https://www.malwaretech.com/challenges/windows-reversing">challenges</a>.</p>
<p>The goal of “strings” challenges is to understand various implementation of strings in malware through static analysis. Strings are very useful in storing the configurations, decryption keys, data and c&amp;c server addresses.</p>
<p>For analysis, I will use IDApro free for analysis. The author of the challenges provides a set of rules to follow while solving the challenges</p>
<p><strong>Rules &amp; Information</strong></p>
<pre><code>- You are not require to run strings1.exe, this challenge is static analysis only.
- Do not use a debugger or dumper to retrieve the decrypted flag from memory, this is cheating.
- Analysis can be done using the free version of IDA Pro (you don’t need the debugger).
</code></pre>
<h2 id="challenge1-Strings1"><a href="#challenge1-Strings1" class="headerlink" title="challenge1- Strings1"></a>challenge1- Strings1</h2><p><strong>Description</strong></p>
<blockquote>
<p>strings1.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>Knowing the binary is a windows PE, we drag the binary into IDA for analysis. The analysis of the binary is fast because the binary relative small. The disassembled code is as the one shown in the image below.</p>
<p><img data-src="/post/mal/strings1.png" alt="Strings IDA"></p>
<p>From the analysis of the above code, we take flag as our input and print out the md5 of the flag. The  <strong>md5_hash</strong> function is responsible for calculating the MD5 hash of the flag. The MessageBoxA is responsible for displaying the md5hash of the flag in a modal dialog box.</p>
<p>The correct flag is <strong>FLAG{CAN-I-MAKE-IT-ANYMORE-OBVIOUS}</strong></p>
<p>Inputting the above flag in the authors website we get a correct message.</p>
<blockquote>
<p>Correct flag for strings1!</p>
</blockquote>
<h2 id="Challenge2-Strings2"><a href="#Challenge2-Strings2" class="headerlink" title="Challenge2- Strings2"></a>Challenge2- Strings2</h2><blockquote>
<p>strings2.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>The goal of the second challenge is to understand about stack strings. stack strings is where strings are copied in single bytes, this helps malware avoid detection algorithms of common strings.</p>
<p>Drag the binary into IDA for analysis. The main function of the binary looks like the one shown in the image below.</p>
<p><img data-src="/post/mal/strings2.png" alt="Strings IDA"></p>
<p>From above disassembled code, the flag string is pushed in single bytes, and then passed to the md5_char function. m5_char function is responsible for calculating the MD5sum of the flag as previous seen in <strong>challenge1</strong>.</p>
<p>The flag of the second challenge is  <strong>FLAG{STACK-STRINGS-ARE-BEST-STRINGS}</strong></p>
<h2 id="Challenge3-Strings3"><a href="#Challenge3-Strings3" class="headerlink" title="Challenge3 - Strings3"></a>Challenge3 - Strings3</h2><blockquote>
<p>strings3.exe contains an un-encrypted flag stored within the executable. When run, the program will output an MD5 hash of the flag but not the original. Can you extract the flag?</p>
</blockquote>
<p>The goal of the third challenge is to understand how malware uses resources section of the PE. Drag the strings3 binary into IDA and disassemble the main function. The disassembled code looks the one in the image below.</p>
<p><img data-src="/post/mal/resourcestrings3.png" alt="Strings IDA"></p>
<p>Looking at the above function is we have a new function, <strong>FindResourceA</strong>. Looking at the windows documentation, FindResourceA function is responsible determination of a resource with the specified type and name in the specified module as shown in the code snip below.</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">HRSRC FindResourceA(
  [in, optional] HMODULE hModule,
  [in]           LPCSTR  lpName,
  [in]           LPCSTR  lpType
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the disassembly above, the name of the resource we are referencing is <strong>rc.rc</strong>. After the execution of FindResourceA function it returns an handle to the specified resource&#96;s information block. In x86 assembly code the return values of functions are put in <strong>eax</strong> register.</p>
<p>From the above code we can reconstruct the c-style code of the FindResource function.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token function">FindResourceA</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"rc.rc"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>The handle module is 0 which is then stored in eax register and then used for calculation of the UID of the resource as shown in assembly below.</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>var_8<span class="token operator">]</span>, <span class="token register variable">eax</span>
mov <span class="token register variable">eax</span>, <span class="token number">1</span>
shl <span class="token register variable">eax</span>, <span class="token number">8</span>
xor <span class="token register variable">edx</span>, <span class="token register variable">edx</span>
inc <span class="token register variable">edx</span>
shl <span class="token register variable">edx</span>, <span class="token number">4</span>
or <span class="token register variable">eax</span>, <span class="token register variable">edx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>From the above assembly code, the value of eax is 0. The first line saves eax value to a memory register.</p>
<p>Second line increments the value of eax register by 1. Therefore the new value of eax register is eax&#x3D;1.</p>
<p>Third line, shifts the bits value of eax register to the left by 8 times. we calculate the new value using python.</p>
<pre class="line-numbers language-python3" data-language="python3"><code class="language-python3">&gt;&gt;&gt; 1 &lt;&lt;8
256
&gt;&gt;&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>value of 1 shifted to the left 8 times becomes 256 as shown above.</p>
<p>Fourth line, is we are clearing the edx register through xor operation. Therefore the value of edx is 0.</p>
<p>Line 5 we increment the value of edx by 1. The new value stored in edx register is 1, <strong>edx&#x3D;1</strong> .</p>
<p>Line 6 we shift the value of edx register by 4 positions to the left.</p>
<pre class="line-numbers language-python3" data-language="python3"><code class="language-python3">&gt;&gt;&gt; 1 &lt;&lt;4
16
&gt;&gt;&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>From the calculation above, the new value od edx register is 16. <strong>edx&#x3D;16</strong>. Therefore for the last line we are doing a bitwise inclusive <strong>OR</strong> operation of value at eax and edx register.</p>
<p>The values for eax and edx registers are 256 and 16 respectively.</p>
<pre class="line-numbers language-python3" data-language="python3"><code class="language-python3">&gt;&gt;&gt; 256 | 16
272
&gt;&gt;&gt; <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>The result of the bits operation are therefore stored on the eax register. The new <strong>eax</strong> value is 272. Finally the value of eax register is the stored in memory address referenced  below by <strong>UID</strong></p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">mov <span class="token operator">[</span><span class="token register variable">ebp</span><span class="token operator">+</span>UID<span class="token operator">]</span>, <span class="token register variable">eax</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img data-src="/post/mal/strings3.png" alt="Strings IDA"></p>
<p>The analysis of the disassembled code above, shows the binary loads a resource from the executable referenced by <strong>uID</strong>. The function structure for the LoadStringA functions looks like the one below.</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int LoadStringA(
  [in, optional] HINSTANCE hInstance,
  [in]           UINT      uID,
  [out]          LPSTR     lpBuffer,
  [in]           int       cchBufferMax
);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The <strong>uID</strong> integer value of the resource to be loaded is 272. For viewing the  executable resources you can use the <strong>ResourcesEditor</strong> tool or python3 <strong>pefile</strong> library as shown in the code below.</p>
<pre class="line-numbers language-python3" data-language="python3"><code class="language-python3">import pefile
pe &#x3D; pefile.PE(&quot;.&#x2F;strings3.exe_&quot;)***
pe.print_info()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>The above 2 line of python3 code print all the information about the executable. As shown below is our resources section and references the string uid we are loading.</p>
<p><img data-src="/post/mal/string3rc.png" alt="PE Resources"></p>
<p>From the image above, we are loading  <strong>FLAG{RESOURCES-ARE-POPULAR-FOR-MALWARE}</strong> string to our buffer through <strong>LoadStringA</strong> function which is referenced by uid 272. The pointer to the string is then passed to md5 function which is then used for calculating the md5 value of the string and then displayed in the modal box.</p>
<p>The correct flag of the challenge is <strong>FLAG{RESOURCES-ARE-POPULAR-FOR-MALWARE}</strong>.</p>
<p>For learning more about resource section of Portable Executable, check <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=3PcgwKffytI">PE resources</a> by  <a target="_blank" rel="noopener" href="https://twitter.com/struppigel">@struppigel</a> .</p>

      </div>
      
      
      
    </div>
  <ul class="breadcrumb">
            <li><a href="/images/">IMAGES</a></li>
            <li><a href="/images/mal/">MAL</a></li>
            <li>STRINGS</li>
  </ul>

    
    


</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thuri</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  





</body>
</html>
