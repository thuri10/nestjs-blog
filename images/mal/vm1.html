<!DOCTYPE html>
<html lang="en">
  <head>
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>Reversing MalwareTech 8-Bit Bytecode Virtual Machine</title>
<meta name="keywords" content="Reversing MalwareTech 8-Bit Bytecode Virtual Machine, LaByte">
<meta name="description" content="Can you figure out how the VM works and write your own to decrypt the flag?">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">


<link rel="stylesheet" href="/style/jquery.fancybox.min.css">




    <link rel="stylesheet" href="/style/prism.css"/>




  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="http://thuri10.github.io">
        <img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="http://thuri10.github.io">
        <h1 class="site-title">LaByte</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        Home
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        Archives
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        About
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">Reversing MalwareTech 8-Bit Bytecode Virtual Machine</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2021-12-07</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/">
              
                
                  ，
                
              </a>
            
              <a href="/">
              
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p>Challenge description.</p>
<blockquote>
<p>vm1.exe implements a simple 8-bit virtual machine (VM) to try and stop reverse engineers from retrieving the flag. The VM’s RAM contains the encrypted flag and some bytecode to decrypt it. Can you figure out how the VM works and write your own to decrypt the flag? A copy of the VM’s RAM has been provided in ram.bin (this data is identical to the ram content of the malware’s VM before execution and contains both the custom assembly code and encrypted flag).</p>
</blockquote>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Main function analysis</p>
<p><img src="/post/mal/vmq.png" alt="Main Function"></p>
<p>From the above image the <strong>HeapAlloc</strong> function allocates a block of memory from a heap. Heapalloc function above,allocates a memory block of size <strong>0x1FB</strong> bytes. The pointer of the allocated memory block is called allocated_memblock as shown in the image.</p>
<p>The program does a <strong>memcpy</strong> of the content stored in the rambin offset to the new allocated memory block.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dest<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>Memcpy functions copies data from the source address to destination address of size 0x1fb. The destination address of this program is the allocate_memblock. Examining the bytes in the rambin file provided as part of the challenge and the content at rambin offset are the same as shown in the image below.</p>
<p><img src="/post/mal/rambin.png" alt="Rambin"> <img src="/post/mal/ida_hex.png" alt="IDA HEX"></p>
<p>Next step is to analyze the <strong>sub_4022E0</strong> function. The disassembled function graph looks like the one below.</p>
<p><img src="/post/mal/vmflow.png" alt="sub_4022E0 control flow loop"></p>
<p>From the disassembly above, the binary is doing some byte operations. The first graph block is doing a bitwise AND operation, which is responsible for setting both SF and ZF to zero.First it sets the value of eax register to 1, and then do a test operation. Because the conditional <strong>“jump if zero”</strong> is not true, we continue our execution to the next control block.</p>
<p>We do decompilation of the function using NSA ghidra tool.The decompiled of the function is shown below.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token keyword">int</span> <span class="token function">FUN_004022e0</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>

<span class="token punctuation">&#123;</span>
  byte bVar1<span class="token punctuation">;</span>
  uint uVar2<span class="token punctuation">;</span>
  byte bVar3<span class="token punctuation">;</span>
  byte counter<span class="token punctuation">;</span>

  counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">/* 0 */</span>
    uVar2 <span class="token operator">=</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>counter<span class="token punctuation">;</span>
                    <span class="token comment">/* 2 */</span>
    bVar1 <span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    bVar3 <span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
    counter <span class="token operator">=</span> counter <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>
    uVar2 <span class="token operator">=</span> <span class="token function">FUN_00402270</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>allocated_memblock <span class="token operator">+</span> <span class="token number">0xff</span> <span class="token operator">+</span> uVar2<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>allocated_memblock <span class="token operator">+</span> <span class="token number">0xff</span> <span class="token operator">+</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>bVar1<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token punctuation">(</span>uint<span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>allocated_memblock <span class="token operator">+</span> <span class="token number">0xff</span> <span class="token operator">+</span> <span class="token punctuation">(</span>uint<span class="token punctuation">)</span>bVar3<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uVar2 <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> uVar2<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The above c-code like is more easier to understand than the assembly code. From the analysis of the code, we are doing a while loop.The assembly equivalent of this operation is as the one shown in the first memory block of the function.</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token label function">loc_4022EA:</span>
mov     <span class="token register variable">eax</span>, <span class="token number">1</span>
test    <span class="token register variable">eax</span>, <span class="token register variable">eax</span>
jz      short loc_402367<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Therefore, we call the function <strong>FUN_00402270</strong> while passing three arguments.The control graph below shows various operation executed by the binary depending on the argument passed to the function.</p>
<p><img src="/post/mal/vmflow2.png" alt="control flow loop"></p>
<p>From the above graph, the function does a compare on the arguments passed with either 1, 2 or 3. If the condition is fulfilled, that operation branch is executed as shown in the image above.</p>
<p>Example: <strong>if the argument value passed is 1, control flow branch to loc_4022E address as shown in the graph</strong></p>
<p>For better understanding of the control flow, we decompile the function using ghidra, because <strong>idafree</strong> does not support x86 decompilation.The “C-like style” of the code looks like the one below.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">
<span class="token keyword">int</span> <span class="token function">FUN_00402270</span><span class="token punctuation">(</span><span class="token keyword">int</span> value1<span class="token punctuation">,</span><span class="token keyword">int</span> value2<span class="token punctuation">,</span><span class="token keyword">int</span> param_3<span class="token punctuation">)</span>

<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value1 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>undefined <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>allocated_memblock <span class="token operator">+</span> value2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>undefined<span class="token punctuation">)</span>param_3<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value1 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      value1 <span class="token operator">=</span> allocated_memblock <span class="token operator">+</span> value2<span class="token punctuation">;</span>
      DAT_00404240 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span>value1<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>value1 <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> value1 <span class="token operator">&amp;</span> <span class="token number">0xffffff00</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      value1 <span class="token operator">=</span> allocated_memblock <span class="token operator">+</span> value2<span class="token punctuation">;</span>
      <span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>allocated_memblock <span class="token operator">+</span> value2<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>byte <span class="token operator">*</span><span class="token punctuation">)</span>value1 <span class="token operator">^</span> DAT_00404240<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token function">CONCAT31</span><span class="token punctuation">(</span><span class="token punctuation">(</span>int3<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uint<span class="token punctuation">)</span>value1 <span class="token operator">>></span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The decompilation output of ghidra is not optimal, therefore decompiled code contains some cast which can be fixed by setting the correct data types in the functional signatures of the function.Because this is an easy VM, we can implement the above code in a python3 script in order to decrypt the contents of <strong>ram.bin</strong> file.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>Fully implemented solution code is below.</p>
<pre class="line-numbers language-python3" data-language="python3"><code class="language-python3">#implement decryption routine function in python
#solution.py
def fun_00402270(value1, value2, value3):
    global dat_420
    if value1 &#x3D;&#x3D; 1:
        membytes[value2] &#x3D; value3
    elif value1 &#x3D;&#x3D; 2:
        dat_420 &#x3D; membytes[value2]
    else:
        if value1 &#x3D;&#x3D; 3:
            membytes[value2] &#x3D; membytes[value2] ^ dat_420
        else:
            return False

    return True


if __name__ &#x3D;&#x3D;&quot;__main__&quot;:
    global membytes
    membytes &#x3D; []

    #open the encypted file and read bytes
    with open(&#39;ram.bin&#39;,&#39;rb&#39;) as rambin:
        membytes&#x3D; list(rambin.read())

    counter  &#x3D;0
    uvar2 &#x3D; 0
    bvar1 &#x3D; 1
    bvar3 &#x3D; 2
    uvar2_response &#x3D; True

    while uvar2_response:
        counter +&#x3D;3
        uvar2_response &#x3D; fun_00402270(membytes[counter+ 0xff + uvar2], membytes[counter+0xff + bvar1], membytes[counter+ 0xff + bvar3])
    print([chr(x) for x in membytes[:26]])
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Running the above script in the terminal gets us our flag</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vx@archie:vm$ python3 x.py
<span class="token punctuation">[</span><span class="token string">'F'</span>, <span class="token string">'L'</span>, <span class="token string">'A'</span>, <span class="token string">'G'</span>, <span class="token string">'&#123;'</span>, <span class="token string">'V'</span>, <span class="token string">'M'</span>, <span class="token string">'S'</span>, <span class="token string">'-'</span>, <span class="token string">'A'</span>, <span class="token string">'R'</span>, <span class="token string">'E'</span>, <span class="token string">'-'</span>, <span class="token string">'F'</span>, <span class="token string">'O'</span>, <span class="token string">'R'</span>, <span class="token string">'-'</span>, <span class="token string">'M'</span>, <span class="token string">'A'</span>, <span class="token string">'L'</span>, <span class="token string">'W'</span>, <span class="token string">'A'</span>, <span class="token string">'R'</span>, <span class="token string">'E'</span>, <span class="token string">'&#125;'</span>, <span class="token string">'\x00'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>After a successful decryption of the rambin contents, the <strong>sub_4022E0</strong> function return the pointer to the flag to main function as shown in the image below.</p>
<p><img src="/post/mal/retflag.png" alt="Return value of sub_4022E0"></p>
<p>Therefore the main function calculates the MD5 hash of the flag and outputs to the message dialogbox using <strong>MessageBoxA</strong> function.</p>
<p>The correct flag for the vm challenge is <strong>FLAG{VMS-ARE-FOR-MALWARE}</strong></p>

        </div>
        <div class="top-div">
          <ol class="top-box"><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#Introduction"><span class="top-box-text">Introduction</span></a></li><li class="top-box-item top-box-level-2"><a class="top-box-link" href="#Solution"><span class="top-box-text">Solution</span></a></li></ol>
        </div>
      </div>
    </div>

    
  </div>




<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a href="https://github.com/thuri10" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
        <a href="https://twitter.com/thuri0" target="_blank">
          <i class="icon icon-twitter"></i>
        </a>
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>
      </div>
      
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.fancybox.min.js"></script>




<script src="/js/main.js"></script>





    </div>
  </body>
</html>

